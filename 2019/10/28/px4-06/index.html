<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: './public/search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="0. 摘要正所谓管中窥豹，可见一斑。单独地阅读某一模块的代码虽然不能让我们立刻开始对代码的二次开发，但能够帮助我们更好地熟悉PX4的代码风格、常用库和函数。 在PX4的诸多模块中，位置控制（fw_pos_control_l1）是一个比较重要的模块，其功能是根据输入的期望位置，输出无人机需要调整到达的姿态和油门。整个模块的计算部分主要通过调用L1和TECS两个库的API来实现，比较适合我们练手。 本">
<meta property="og:type" content="article">
<meta property="og:title" content="px4学习笔记[06]-固定翼位置控制模块源码分析">
<meta property="og:url" content="http://yoursite.com/2019/10/28/px4-06/index.html">
<meta property="og:site_name" content="yerfor&#39;s Journey">
<meta property="og:description" content="0. 摘要正所谓管中窥豹，可见一斑。单独地阅读某一模块的代码虽然不能让我们立刻开始对代码的二次开发，但能够帮助我们更好地熟悉PX4的代码风格、常用库和函数。 在PX4的诸多模块中，位置控制（fw_pos_control_l1）是一个比较重要的模块，其功能是根据输入的期望位置，输出无人机需要调整到达的姿态和油门。整个模块的计算部分主要通过调用L1和TECS两个库的API来实现，比较适合我们练手。 本">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/00-ku.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/01-math.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/02-class.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/03-coef.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/04-paramhandle.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/05-gouzao.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/06-state.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/07-private1.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/08-private2.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/09-private3.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/10-private4.png">
<meta property="og:image" content="http://yoursite.com/2019/10/28/px4-06/11.png">
<meta property="article:published_time" content="2019-10-28T05:03:45.000Z">
<meta property="article:modified_time" content="2019-12-12T08:19:21.000Z">
<meta property="article:author" content="Zhenhui Ye">
<meta property="article:tag" content="PX4">
<meta property="article:tag" content="Cybernetic">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2019/10/28/px4-06/00-ku.png">

<link rel="canonical" href="http://yoursite.com/2019/10/28/px4-06/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>px4学习笔记[06]-固定翼位置控制模块源码分析 | yerfor's Journey</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yerfor's Journey</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/28/px4-06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/face.jpg">
      <meta itemprop="name" content="Zhenhui Ye">
      <meta itemprop="description" content="Be a superhero.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yerfor's Journey">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          px4学习笔记[06]-固定翼位置控制模块源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-28 13:03:45" itemprop="dateCreated datePublished" datetime="2019-10-28T13:03:45+08:00">2019-10-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-12 16:19:21" itemprop="dateModified" datetime="2019-12-12T16:19:21+08:00">2019-12-12</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="0-摘要"><a href="#0-摘要" class="headerlink" title="0. 摘要"></a>0. 摘要</h1><p>正所谓管中窥豹，可见一斑。单独地阅读某一模块的代码虽然不能让我们立刻开始对代码的二次开发，但能够帮助我们更好地熟悉PX4的代码风格、常用库和函数。</p>
<p>在PX4的诸多模块中，位置控制（fw_pos_control_l1）是一个比较重要的模块，其功能是根据输入的期望位置，输出无人机需要调整到达的姿态和油门。整个模块的计算部分主要通过调用L1和TECS两个库的API来实现，比较适合我们练手。</p>
<p>本文简单介绍了：</p>
<ul>
<li>px4代码的命名规则</li>
<li>px4代码中常用的库、函数的解释</li>
<li><code>fw_pos_control_l1</code>模块的代码分析</li>
</ul>
<a id="more"></a>
<h1 id="1-头文件分析"><a href="#1-头文件分析" class="headerlink" title="1. 头文件分析"></a>1. 头文件分析</h1><p>头文件的源码和注释见 3.附录。</p>
<h2 id="1-1-命名规则"><a href="#1-1-命名规则" class="headerlink" title="1.1 命名规则"></a>1.1 命名规则</h2><p>PX4的命名规则大致遵循以下规则：</p>
<ul>
<li><p>类名称，在每个单词的首字母处大写，如<code>FixedwingPositionControl</code></p>
</li>
<li><p>类内的变量实例，命名采用下划线开头，如：<code>_control_mode_sub</code></p>
</li>
<li><p>自定义类型，命名采用下划线加字母的形式结束，如：</p>
<p>​    1. 以<code>_t</code>结尾，比如<code>orb_advert_t</code>，以t为结尾，说明这个类型是一个句柄，它的实例一般是一个sub或者pub。</p>
<p>​    2. 以<code>_s</code>结尾，比如<code>vehicle_attitude_s</code>，以s为结尾，说明这个类型是一个数据结构体，它的实例一般是存储某个参数的结构体。</p>
</li>
<li><p>类外面的参数，用全大写字母加下滑线命名，如<code>THROTTLE_THRESH</code></p>
</li>
</ul>
<h2 id="1-2-库的引用"><a href="#1-2-库的引用" class="headerlink" title="1.2 库的引用"></a>1.2 库的引用</h2><p>fw_pos_control_l1所调用的库如下图所示，大致可以分为三种</p>
<ul>
<li><p>第三方功能库，比如：</p>
<ul>
<li>提供精确计时、性能策略的<code>drv_hrt</code></li>
<li>提供<code>L1</code>和<code>TECS</code>控制API的<code>ecl</code>库</li>
<li>提供数学工具的<code>mathlib</code>、<code>geo</code>等库</li>
</ul>
</li>
<li><p>PX4常用模块库</p>
</li>
<li>uORB的模块库和定义好的消息类型</li>
</ul>
<p><img src="/2019/10/28/px4-06/00-ku.png" alt="00-ku"></p>
<h2 id="1-3-数学工具"><a href="#1-3-数学工具" class="headerlink" title="1.3 数学工具"></a>1.3 数学工具</h2><p>下面是所调用的一些数学工具，包括简单的数学函数，以及存储数据的容器。</p>
<p><img src="/2019/10/28/px4-06/01-math.png" alt="01-math"></p>
<h2 id="1-4-FixedwingPositionControl类"><a href="#1-4-FixedwingPositionControl类" class="headerlink" title="1.4 FixedwingPositionControl类"></a>1.4 FixedwingPositionControl类</h2><h3 id="1-4-1-public"><a href="#1-4-1-public" class="headerlink" title="1.4.1 public"></a>1.4.1 public</h3><p>public下主要是构造函数和顶层的成员函数（包括fw_pos_control模块的主程序run函数和一些命令行操作）。</p>
<p><img src="/2019/10/28/px4-06/02-class.png" alt="02-class"></p>
<h3 id="1-4-2-飞行参数"><a href="#1-4-2-飞行参数" class="headerlink" title="1.4.2 飞行参数"></a>1.4.2 飞行参数</h3><p>首先给出了在类外面定义一些的参数，这些参数只在本模块的源文件里会用到。</p>
<p><img src="/2019/10/28/px4-06/03-coef.png" alt="03-coef"></p>
<p>然后是比较重要的，在private里定义的飞行参数，这些参数都是可以在地面站里面查阅、修改的。程序获取这些参数的方法是：</p>
<ul>
<li>在构造函数中定义一个包含多个sub的结构体<code>_parameter_handles</code>，在<code>param_update</code>函数中，对该结构体里的所有sub使用<code>poll</code>，获取订阅更新，存储在本地一个用来储存所有飞行参数的结构体<code>_parameters</code>中。</li>
</ul>
<p>其中，一个结构体中存储的飞行参数内容如下：</p>
<p><img src="/2019/10/28/px4-06/04-paramhandle.png" alt="04-paramhandle"></p>
<p>上图中每个<code>param_t</code>都是uORB中某个消息的sub句柄，在构造函数中，展示了各个句柄和消息名称的对应关系，如下：</p>
<p><img src="/2019/10/28/px4-06/05-gouzao.png" alt="05-gouzao"></p>
<h3 id="1-4-3-飞行状态量"><a href="#1-4-3-飞行状态量" class="headerlink" title="1.4.3 飞行状态量"></a>1.4.3 飞行状态量</h3><p>private中还定义了大量的飞行状态量，从姿态状态<code>_att</code>到姿态状态的期望值<code>_att_sp</code>，到订阅、发布它们的句柄，再到判定各种模式的flag。这些状态量都以下划线<code>_</code>开头，所以可以很容易辨别出来。</p>
<p>由于状态量过于繁多，所以这里不一一介绍，下图是部分典型的飞行状态量的定义。</p>
<p><img src="/2019/10/28/px4-06/06-state.png" alt="06-state"></p>
<h3 id="1-4-4-底层函数"><a href="#1-4-4-底层函数" class="headerlink" title="1.4.4 底层函数"></a>1.4.4 底层函数</h3><p>我们刚才已经看到，<code>FixedwingPositionControl</code>类的public中只有寥寥几个函数，与实际运行相关的只有一个顶层的run函数。其余较底层的函数都定义在private当中，实际上底层函数也不是很多，大致可以分成几类：</p>
<h4 id="1-4-4-1-飞行参数更新函数param-update"><a href="#1-4-4-1-飞行参数更新函数param-update" class="headerlink" title="1.4.4.1 飞行参数更新函数param_update"></a>1.4.4.1 飞行参数更新函数<code>param_update</code></h4><p><img src="/2019/10/28/px4-06/07-private1.png" alt="07-private1"></p>
<h4 id="1-4-4-2-飞行状态量的订阅更新和发布函数"><a href="#1-4-4-2-飞行状态量的订阅更新和发布函数" class="headerlink" title="1.4.4.2 飞行状态量的订阅更新和发布函数"></a>1.4.4.2 飞行状态量的订阅更新和发布函数</h4><p><img src="/2019/10/28/px4-06/08-private2.png" alt="08-private2"></p>
<h4 id="1-4-4-3-等级仅次于run的控制函数"><a href="#1-4-4-3-等级仅次于run的控制函数" class="headerlink" title="1.4.4.3 等级仅次于run的控制函数"></a>1.4.4.3 等级仅次于run的控制函数</h4><p>分为position（正常飞）、takeoff（起飞）、landing（着陆）三个阶段。run函数中调用的就是这个层级的函数。</p>
<p><img src="/2019/10/28/px4-06/09-private3.png" alt="09-private3"></p>
<h4 id="1-4-4-4-其他飞控相关的底层函数"><a href="#1-4-4-4-其他飞控相关的底层函数" class="headerlink" title="1.4.4.4 其他飞控相关的底层函数"></a>1.4.4.4 其他飞控相关的底层函数</h4><p>包括各种状态量setpoint的估计（基于TECS和L1）、一些飞行状态的判断函数等，罗列如下，具体功能用到时分析。</p>
<p><img src="/2019/10/28/px4-06/10-private4.png" alt="10-private4"></p>
<h1 id="2-源文件分析"><a href="#2-源文件分析" class="headerlink" title="2. 源文件分析"></a>2. 源文件分析</h1><p>源文件的源码和注释见 3.附录。</p>
<p>step1. 运行main函数，创建一个<code>FixedwingPositionControl</code>的实例并运行其main函数</p>
<p><img src="/2019/10/28/px4-06/11.png" alt="11"></p>
<p>step2. 首先运行<code>FixedwingPositionControl</code>的构造函数，获取最新的飞行参数。</p>
<p>step3. 随后调用<code>FixedwingPositionControl</code>的main函数，main函数继承自ModuleBase，一番辗转后会调用run函数。</p>
<p>step4. 在run函数中，定义了一个主循环（38行），订阅消息的频率是50hz，每次循环的触发需要以下两个条件至少其一：global_pos有更新，或者等待时间超过100ms。</p>
<p>随后程序会进入position_control函数（121行）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::<span class="built_in">run</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * do subscriptions</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//定义sub句柄</span></span><br><span class="line">	_global_pos_sub = orb_subscribe(ORB_ID(vehicle_global_position));</span><br><span class="line">	_local_pos_sub = orb_subscribe(ORB_ID(vehicle_local_position));</span><br><span class="line">	_pos_sp_triplet_sub = orb_subscribe(ORB_ID(position_setpoint_triplet));</span><br><span class="line">	_control_mode_sub = orb_subscribe(ORB_ID(vehicle_control_mode));</span><br><span class="line">	_vehicle_attitude_sub = orb_subscribe(ORB_ID(vehicle_attitude));</span><br><span class="line">	_vehicle_command_sub = orb_subscribe(ORB_ID(vehicle_command));</span><br><span class="line">	_vehicle_status_sub = orb_subscribe(ORB_ID(vehicle_status));</span><br><span class="line">	_vehicle_land_detected_sub = orb_subscribe(ORB_ID(vehicle_land_detected));</span><br><span class="line">	_params_sub = orb_subscribe(ORB_ID(parameter_update));</span><br><span class="line">	_manual_control_sub = orb_subscribe(ORB_ID(manual_control_setpoint));</span><br><span class="line">	_sensor_baro_sub = orb_subscribe(ORB_ID(sensor_baro));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置每次迭代间隔为20ms</span></span><br><span class="line">	<span class="comment">/* rate limit position updates to 50 Hz */</span></span><br><span class="line">	orb_set_interval(_global_pos_sub, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* abort on a nonzero return value from the parameter init */</span></span><br><span class="line">	<span class="keyword">if</span> (parameters_update() != PX4_OK) &#123;</span><br><span class="line">		<span class="comment">/* parameter setup went wrong, abort */</span></span><br><span class="line">		PX4_ERR(<span class="string">"aborting startup due to errors."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* wakeup source(s) */</span></span><br><span class="line">	<span class="keyword">px4_pollfd_struct_t</span> fds[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Setup of loop */</span></span><br><span class="line">    <span class="comment">//fds中只保存全球位置信息，也就是说，我们只在意全球位置信息发生变化这个事件</span></span><br><span class="line">	fds[<span class="number">0</span>].fd = _global_pos_sub;</span><br><span class="line">	fds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (!should_exit()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* wait for up to 500ms for data */</span></span><br><span class="line">        <span class="comment">//这里官方源码说错了，应该是等待参数更新，直到100ms</span></span><br><span class="line">		<span class="keyword">int</span> pret = px4_poll(&amp;fds[<span class="number">0</span>], (<span class="keyword">sizeof</span>(fds) / <span class="keyword">sizeof</span>(fds[<span class="number">0</span>])), <span class="number">100</span>);</span><br><span class="line">        <span class="comment">//下面两个if语句是对订阅更新过程出现bug的处理，如果订阅出错，程序直接进入下次循环</span></span><br><span class="line">		<span class="comment">/* timed out - periodic check for _task_should_exit, etc. */</span></span><br><span class="line">		<span class="keyword">if</span> (pret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* this is undesirable but not much we can do - might want to flag unhappy status */</span></span><br><span class="line">		<span class="keyword">if</span> (pret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			PX4_WARN(<span class="string">"poll error %d, %d"</span>, pret, errno);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* only update parameters if they changed */</span></span><br><span class="line">        <span class="comment">//如果正常接收到了更新的参数，那么执行下面的代码：</span></span><br><span class="line">        <span class="keyword">bool</span> params_updated = <span class="literal">false</span>;</span><br><span class="line">        orb_check(_params_sub, &amp;params_updated);<span class="comment">//检查订阅的飞行参数更新了没</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果更新了，就更新本地储存的飞行参数</span></span><br><span class="line">		<span class="keyword">if</span> (params_updated) &#123;</span><br><span class="line">			<span class="comment">/* read from param to clear updated flag */</span></span><br><span class="line">			parameter_update_s update;</span><br><span class="line">			orb_copy(ORB_I沙特D(parameter_update), _params_sub, &amp;update);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* update parameters from storage */</span></span><br><span class="line">			parameters_update();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* only run controller if position changed */</span></span><br><span class="line">        <span class="comment">//如果检测到飞机的全球位置发生改变</span></span><br><span class="line">		<span class="keyword">if</span> ((fds[<span class="number">0</span>].revents &amp; POLLIN) != <span class="number">0</span>) &#123;</span><br><span class="line">			perf_begin(_loop_perf);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* load local copies */</span></span><br><span class="line">            <span class="comment">//在本地更新储存最新的全球位置和本地位置</span></span><br><span class="line">			orb_copy(ORB_ID(vehicle_global_position), _global_pos_sub, &amp;_global_pos);</span><br><span class="line">			orb_copy(ORB_ID(vehicle_local_position), _local_pos_sub, &amp;_local_pos);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// handle estimator reset events. we only adjust setpoins for manual modes</span></span><br><span class="line">            <span class="comment">//如果是手动控制,进行高度的互补滤波</span></span><br><span class="line">			<span class="keyword">if</span> (_control_mode.flag_control_manual_enabled) &#123;</span><br><span class="line">				<span class="keyword">if</span> (_control_mode.flag_control_altitude_enabled &amp;&amp; _global_pos.alt_reset_counter != _alt_reset_counter) &#123;</span><br><span class="line">                    _hold_alt += _global_pos.delta_alt;</span><br><span class="line">					<span class="comment">// make TECS accept step in altitude and demanded altitude</span></span><br><span class="line">                    _tecs.handle_alt_step(_global_pos.delta_alt, _global_pos.alt);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// adjust navigation waypoints in position control mode</span></span><br><span class="line">				<span class="keyword">if</span> (_control_mode.flag_control_altitude_enabled &amp;&amp; _control_mode.flag_control_velocity_enabled</span><br><span class="line">				    &amp;&amp; _global_pos.lat_lon_reset_counter != _pos_reset_counter) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// reset heading hold flag, which will re-initialise position control</span></span><br><span class="line">					_hdg_hold_enabled = <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// update the reset counters in any case</span></span><br><span class="line">			_alt_reset_counter = _global_pos.alt_reset_counter;</span><br><span class="line">			_pos_reset_counter = _global_pos.lat_lon_reset_counter;</span><br><span class="line"></span><br><span class="line">			_sub_sensors.update();</span><br><span class="line">			airspeed_poll();</span><br><span class="line">			manual_control_setpoint_poll();</span><br><span class="line">			position_setpoint_triplet_poll();</span><br><span class="line">			vehicle_attitude_poll();</span><br><span class="line">			vehicle_command_poll();</span><br><span class="line">			vehicle_control_mode_poll();</span><br><span class="line">			vehicle_land_detected_poll();</span><br><span class="line">			vehicle_status_poll();</span><br><span class="line"></span><br><span class="line">			<span class="function">Vector2f <span class="title">curr_pos</span><span class="params">((<span class="keyword">float</span>)_global_pos.lat, (<span class="keyword">float</span>)_global_pos.lon)</span></span>;</span><br><span class="line">			<span class="function">Vector2f <span class="title">ground_speed</span><span class="params">(_global_pos.vel_n, _global_pos.vel_e)</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Attempt to control position, on success (= sensors present and not in manual mode),</span></span><br><span class="line"><span class="comment">			 * publish setpoint.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//尝试进入control_position函数，如果返回true说明函数给出了setpoint。</span></span><br><span class="line">			<span class="keyword">if</span> (control_position(curr_pos, ground_speed, _pos_sp_triplet.previous, _pos_sp_triplet.current, _pos_sp_triplet.next)) &#123;</span><br><span class="line">				_att_sp.timestamp = hrt_absolute_time();</span><br><span class="line">                <span class="comment">//正常完成一次position control的迭代之后</span></span><br><span class="line">				<span class="comment">// add att沙特itude setpoint offsets</span></span><br><span class="line">                <span class="comment">//给setpoint加上偏置</span></span><br><span class="line">				_att_sp.roll_body += _parameters.rollsp_offset_rad;</span><br><span class="line">				_att_sp.pitch_body += _parameters.pitchsp_offset_rad;</span><br><span class="line">                <span class="comment">//如果是手动模式，还要检查输出的值是否在范围内。</span></span><br><span class="line">				<span class="keyword">if</span> (_control_mode.flag_control_manual_enabled) &#123;</span><br><span class="line">					_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, -_parameters.man_roll_max_rad, _parameters.man_roll_max_rad);</span><br><span class="line">					_att_sp.pitch_body = <span class="built_in">constrain</span>(_att_sp.pitch_body, -_parameters.man_pitch_max_rad, _parameters.man_pitch_max_rad);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//生成四元数沙特矩阵</span></span><br><span class="line">				<span class="function">Quatf <span class="title">q</span><span class="params">(Eulerf(_att_sp.roll_body, _att_sp.pitch_body, _att_sp.yaw_body))</span></span>;</span><br><span class="line">				q.copyTo(_att_sp.q_d);</span><br><span class="line">				_att_sp.q_d_valid = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//setpoint的广播事宜</span></span><br><span class="line">				<span class="keyword">if</span> (!_control_mode.flag_control_offboard_enabled ||</span><br><span class="line">				    _control_mode.flag_control_position_enabled ||</span><br><span class="line">				    _control_mode.flag_control_velocity_enabled ||</span><br><span class="line">				    _control_mode.flag_control_acceleration_enabled) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="comment">/* lazily publish the setpoint only once available */</span></span><br><span class="line">					<span class="keyword">if</span> (_attitude_sp_pub != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">						<span class="comment">/* publish the attitude setpoint */</span></span><br><span class="line">						orb_publish(_attitude_setpoint_id, _attitude_sp_pub, &amp;_att_sp);</span><br><span class="line"></span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_attitude_setpoint_id != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">						<span class="comment">/* advertise and publish */</span></span><br><span class="line">						_attitude_sp_pub = orb_advertise(_attitude_setpoint_id, &amp;_att_sp);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// only publish status in full FW mode</span></span><br><span class="line">					<span class="keyword">if</span> (!_vehicle_status.is_rotary_wing &amp;&amp; !_vehicle_status.in_transition_mode) &#123;</span><br><span class="line">						status_publish();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			perf_end(_loop_perf);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>step5. position_control是更新姿态角、油门的函数，无论是什么飞行模式，必定运行。只要顺利更新了姿态和油门，就返回True。</p>
<p>进入函数之后，会判断是不是自动驾驶模式，是的话会在细分，position还是loiter、takeoff、land（起飞和降落会再调用control_takeoff函数），会调用不同的L1系统API，以及TECS。如果不是自动驾驶模式，还有其他手工飞行模式，这里不研究。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在run中调用，无论是什么模式，必定运行。只要顺利更新了姿态和油门，就返回True</span></span><br><span class="line"><span class="keyword">bool</span></span><br><span class="line">FixedwingPositionControl::control_position(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed,</span><br><span class="line">		<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> dt = <span class="number">0.01f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_control_position_last_called &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		dt = hrt_elapsed_time(&amp;_control_position_last_called) * <span class="number">1e-6</span>f;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_control_position_last_called = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">	_l1_control.set_dt(dt);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* only run position controller in fixed-wing mode and during transitions for VTOL */</span></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_status.is_rotary_wing &amp;&amp; !_vehicle_status.in_transition_mode) &#123;</span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_OTHER;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> setpoint = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	_att_sp.fw_control_yaw = <span class="literal">false</span>;		<span class="comment">// by default we don't want yaw to be contoller directly with rudder</span></span><br><span class="line">	_att_sp.apply_flaps = vehicle_attitude_setpoint_s::FLAPS_OFF;		<span class="comment">// by default we don't use flaps</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新_gndspeed_undershoot,关于这个参数的概念见该函数前的注释</span></span><br><span class="line">	calculate_gndspeed_undershoot(curr_pos, ground_speed, pos_sp_prev, pos_sp_curr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个巡航速度，初始值为地速</span></span><br><span class="line">	Vector2f nav_speed_2d&#123;ground_speed&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_airspeed_valid) &#123;</span><br><span class="line">		<span class="comment">// l1 navigation logic breaks down when wind speed exceeds max airspeed</span></span><br><span class="line">		<span class="comment">// compute 2D groundspeed from airspeed-heading projection</span></span><br><span class="line">        <span class="comment">//将垂直平面内空速进行分解</span></span><br><span class="line">		const Vector2f air_speed_2d&#123;_airspeed * cosf(_yaw), _airspeed * sinf(_yaw)&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// angle between air_speed_2d and ground_speed</span></span><br><span class="line">        <span class="comment">// 得到空速和地速之间的夹角</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> air_gnd_angle = acosf((air_speed_2d * ground_speed) / (air_speed_2d.length() * ground_speed.length()));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if angle &gt; 90 degrees or groundspeed is less than threshold, replace groundspeed with airspeed projection</span></span><br><span class="line">		<span class="keyword">if</span> ((fabsf(air_gnd_angle) &gt; M_PI_2_F) || (ground_speed.length() &lt; <span class="number">3.0f</span>)) &#123;</span><br><span class="line">			nav_speed_2d = air_speed_2d;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* no throttle limit as default */</span></span><br><span class="line">	<span class="keyword">float</span> throttle_max = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* save time when airplane is in air */</span></span><br><span class="line">	<span class="keyword">if</span> (!_was_in_air &amp;&amp; !_vehicle_land_detected.landed) &#123;</span><br><span class="line">		_was_in_air = <span class="literal">true</span>;</span><br><span class="line">		_time_went_in_air = hrt_absolute_time();</span><br><span class="line">		_takeoff_ground_alt = _global_pos.alt;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* reset flag when airplane landed */</span></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_land_detected.landed) &#123;</span><br><span class="line">		_was_in_air = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Reset integrators if switching to this mode from a other mode in which posctl was not active */</span></span><br><span class="line">	<span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_OTHER) &#123;</span><br><span class="line">		<span class="comment">/* reset integrators */</span></span><br><span class="line">		_tecs.reset_state();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自动控制模式（从navigator接受sp）：</span></span><br><span class="line">	<span class="keyword">if</span> (_control_mode.flag_control_auto_enabled &amp;&amp; pos_sp_curr.valid) &#123;</span><br><span class="line">		<span class="comment">/* AUTONOMOUS FLIGHT */</span></span><br><span class="line"></span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_AUTO;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset hold altitude */</span></span><br><span class="line">		_hold_alt = _global_pos.alt;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset hold yaw */</span></span><br><span class="line">		_hdg_hold_yaw = _yaw;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* get circle mode */</span></span><br><span class="line">		<span class="keyword">bool</span> was_circle_mode = _l1_control.circle_mode();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* restore TECS parameters, in case changed intermittently (e.g. in landing handling) */</span></span><br><span class="line">		_tecs.set_speed_weight(_parameters.speed_weight);</span><br><span class="line">		_tecs.set_time_const_throt(_parameters.time_const_throt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* current waypoint (the one currently heading for) */</span></span><br><span class="line">		<span class="function">Vector2f <span class="title">curr_wp</span><span class="params">((<span class="keyword">float</span>)pos_sp_curr.lat, (<span class="keyword">float</span>)pos_sp_curr.lon)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Initialize attitude controller integrator reset flags to 0 */</span></span><br><span class="line">		_att_sp.roll_reset_integral = <span class="literal">false</span>;</span><br><span class="line">		_att_sp.pitch_reset_integral = <span class="literal">false</span>;</span><br><span class="line">		_att_sp.yaw_reset_integral = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* previous waypoint */</span></span><br><span class="line">		Vector2f prev_wp&#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">			prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_prev.lat;</span><br><span class="line">			prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_prev.lon;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * No valid previous waypoint, go for the current wp.</span></span><br><span class="line"><span class="comment">			 * This is automatically handled by the L1 library.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_curr.lat;</span><br><span class="line">			prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_curr.lon;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//以下生成速度和油门的sp，留待下文传输到TECS中。</span></span><br><span class="line">        <span class="comment">//默认期望以巡航速度飞行</span></span><br><span class="line">		<span class="keyword">float</span> mission_airspeed = _parameters.airspeed_trim;</span><br><span class="line">        <span class="comment">//如果当前sp有设定的速度，就覆盖原来的值</span></span><br><span class="line">		<span class="keyword">if</span> (PX4_ISFINITE(pos_sp_curr.cruising_speed) &amp;&amp;</span><br><span class="line">		    pos_sp_curr.cruising_speed &gt; <span class="number">0.1f</span>) &#123;</span><br><span class="line"></span><br><span class="line">			mission_airspeed = pos_sp_curr.cruising_speed;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//默认期望以巡航油门飞行</span></span><br><span class="line">		<span class="keyword">float</span> mission_throttle = _parameters.throttle_cruise;</span><br><span class="line">        <span class="comment">//如果当前sp有设定的油门，就覆盖原来的值</span></span><br><span class="line">		<span class="keyword">if</span> (PX4_ISFINITE(pos_sp_curr.cruising_throttle) &amp;&amp;</span><br><span class="line">		    pos_sp_curr.cruising_throttle &gt; <span class="number">0.01f</span>) &#123;</span><br><span class="line"></span><br><span class="line">			mission_throttle = pos_sp_curr.cruising_throttle;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//前面是只要是自动控制模式，所有子模式都运行的，下面是各个子任务的分支。</span></span><br><span class="line">        <span class="comment">//如果当前sp的模式是IDLE，那么三个输入（油门、滚转、俯仰）都是0</span></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_IDLE) &#123;</span><br><span class="line">			_att_sp.thrust_body[<span class="number">0</span>] = <span class="number">0.0f</span>;</span><br><span class="line">			_att_sp.roll_body = <span class="number">0.0f</span>;</span><br><span class="line">			_att_sp.pitch_body = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前sp的模式是POSITION，那么首先调用l1控制的获得下一个路径点，获得需要的滚转角。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_POSITION) &#123;</span><br><span class="line">			<span class="comment">/* waypoint is a plain navigation waypoint */</span></span><br><span class="line">			_l1_control.navigate_waypoints(prev_wp, curr_wp, curr_pos, nav_speed_2d);</span><br><span class="line">			_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">            _att_sp.yaw_body = _l1_control.nav_bearing();<span class="comment">//nav_bearing默认是0</span></span><br><span class="line">            <span class="comment">//更新TECS系统，设定相应的油门和俯仰</span></span><br><span class="line">			tecs_update_pitch_throttle(pos_sp_curr.alt,</span><br><span class="line">						   calculate_target_airspeed(mission_airspeed),</span><br><span class="line">						   radians(_parameters.pitch_limit_min) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   radians(_parameters.pitch_limit_max) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   _parameters.throttle_min,</span><br><span class="line">						   _parameters.throttle_max,</span><br><span class="line">						   mission_throttle,</span><br><span class="line">						   <span class="literal">false</span>,</span><br><span class="line">						   radians(_parameters.pitch_limit_min));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前sp的模式是悬停，那么也是首先调用l1控制的获得下一个路径点（调用的api和上面的不一样），获得需要的滚转角。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_LOITER) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* waypoint is a loiter waypoint */</span></span><br><span class="line">			_l1_control.navigate_loiter(curr_wp, curr_pos, pos_sp_curr.loiter_radius,</span><br><span class="line">						    pos_sp_curr.loiter_direction, nav_speed_2d);</span><br><span class="line">			_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">			_att_sp.yaw_body = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">float</span> alt_sp = pos_sp_curr.alt;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (pos_sp_next.type == position_setpoint_s::SETPOINT_TYPE_LAND &amp;&amp; pos_sp_next.valid</span><br><span class="line">			    &amp;&amp; _l1_control.circle_mode() &amp;&amp; _parameters.land_early_config_change == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="comment">// We're in a loiter directly before a landing WP. Enable our landing configuration (flaps,</span></span><br><span class="line">				<span class="comment">// landing airspeed and potentially tighter throttle control) already such that we don't</span></span><br><span class="line">				<span class="comment">// have to do this switch (which can cause significant altitude errors) close to the ground.</span></span><br><span class="line">				_tecs.set_time_const_throt(_parameters.land_throtTC_scale * _parameters.time_const_throt);</span><br><span class="line">				mission_airspeed = _parameters.land_airspeed_scale * _parameters.airspeed_min;</span><br><span class="line">				_att_sp.apply_flaps = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">				alt_sp = <span class="built_in">max</span>(alt_sp, _takeoff_ground_alt + _parameters.climbout_diff);</span><br><span class="line">				_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, radians(<span class="number">-5.0f</span>), radians(<span class="number">5.0f</span>));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_land_abort) &#123;</span><br><span class="line">				<span class="keyword">if</span> (pos_sp_curr.alt - _global_pos.alt  &lt; _parameters.climbout_diff) &#123;</span><br><span class="line">					<span class="comment">// aborted landing complete, normal loiter over landing point</span></span><br><span class="line">					abort_landing(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">// continue straight until vehicle has sufficient altitude</span></span><br><span class="line">					_att_sp.roll_body = <span class="number">0.0f</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				_tecs.set_time_const_throt(_parameters.land_throtTC_scale * _parameters.time_const_throt);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			tecs_update_pitch_throttle(alt_sp,</span><br><span class="line">						   calculate_target_airspeed(mission_airspeed),</span><br><span class="line">						   radians(_parameters.pitch_limit_min) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   radians(_parameters.pitch_limit_max) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   _parameters.throttle_min,</span><br><span class="line">						   _parameters.throttle_max,</span><br><span class="line">						   _parameters.throttle_cruise,</span><br><span class="line">						   <span class="literal">false</span>,</span><br><span class="line">						   radians(_parameters.pitch_limit_min));</span><br><span class="line">        <span class="comment">//如果当前sp的模式是降落，调用control_land函数。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_LAND) &#123;</span><br><span class="line">			control_landing(curr_pos, ground_speed, pos_sp_prev, pos_sp_curr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前sp的模式是降落，调用control_takeoff函数。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF) &#123;</span><br><span class="line">			control_takeoff(curr_pos, ground_speed, pos_sp_prev, pos_sp_curr);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset landing state */</span></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_curr.type != position_setpoint_s::SETPOINT_TYPE_LAND) &#123;</span><br><span class="line">			reset_landing_state();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset takeoff/launch state */</span></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_curr.type != position_setpoint_s::SETPOINT_TYPE_TAKEOFF) &#123;</span><br><span class="line">			reset_takeoff_state();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (was_circle_mode &amp;&amp; !_l1_control.circle_mode()) &#123;</span><br><span class="line">			<span class="comment">/* just kicked out of loiter, reset roll integrals */</span></span><br><span class="line">			_att_sp.roll_reset_integral = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果不是自动控制模式，而是手工的定速度、定高度控制</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode.flag_control_velocity_enabled &amp;&amp;</span><br><span class="line">		   _control_mode.flag_control_altitude_enabled) &#123;</span><br><span class="line">		<span class="comment">/* POSITION CONTROL: pitch stick moves altitude setpoint, throttle stick sets airspeed,</span></span><br><span class="line"><span class="comment">		   heading is set to a distant waypoint */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_control_mode_current != FW_POSCTRL_MODE_POSITION) &#123;</span><br><span class="line">			<span class="comment">/* Need to init because last loop iteration was in a different mode */</span></span><br><span class="line">			_hold_alt = _global_pos.alt;</span><br><span class="line">			_hdg_hold_yaw = _yaw;</span><br><span class="line">			_hdg_hold_enabled = <span class="literal">false</span>; <span class="comment">// this makes sure the waypoints are reset below</span></span><br><span class="line">			_yaw_lock_engaged = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* reset setpoints from other modes (auto) otherwise we won't</span></span><br><span class="line"><span class="comment">			 * level out without new manual input */</span></span><br><span class="line">			_att_sp.roll_body = _manual.y * _parameters.man_roll_max_rad;</span><br><span class="line">			_att_sp.yaw_body = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_POSITION;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> altctrl_airspeed = get_demanded_airspeed();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* update desired altitude based on user pitch stick input */</span></span><br><span class="line">		<span class="keyword">bool</span> climbout_requested = update_desired_altitude(dt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if we assume that user is taking off then help by demanding altitude setpoint well above ground</span></span><br><span class="line">		<span class="comment">// and set limit to pitch angle to prevent steering into ground</span></span><br><span class="line">		<span class="comment">// this will only affect planes and not VTOL</span></span><br><span class="line">		<span class="keyword">float</span> pitch_limit_min = _parameters.pitch_limit_min;</span><br><span class="line">		do_takeoff_help(&amp;_hold_alt, &amp;pitch_limit_min);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* throttle limiting */</span></span><br><span class="line">		throttle_max = _parameters.throttle_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_land_detected.landed &amp;&amp; (fabsf(_manual.z) &lt; THROTTLE_THRESH)) &#123;</span><br><span class="line">			throttle_max = <span class="number">0.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(_hold_alt,</span><br><span class="line">					   altctrl_airspeed,</span><br><span class="line">					   radians(_parameters.pitch_limit_min),</span><br><span class="line">					   radians(_parameters.pitch_limit_max),</span><br><span class="line">					   _parameters.throttle_min,</span><br><span class="line">					   throttle_max,</span><br><span class="line">					   _parameters.throttle_cruise,</span><br><span class="line">					   climbout_requested,</span><br><span class="line">					   climbout_requested ? radians(<span class="number">10.0f</span>) : pitch_limit_min,</span><br><span class="line">					   tecs_status_s::TECS_MODE_NORMAL);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* heading control */</span></span><br><span class="line">		<span class="keyword">if</span> (fabsf(_manual.y) &lt; HDG_HOLD_MAN_INPUT_THRESH &amp;&amp;</span><br><span class="line">		    fabsf(_manual.r) &lt; HDG_HOLD_MAN_INPUT_THRESH) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* heading / roll is zero, lock onto current heading */</span></span><br><span class="line">			<span class="keyword">if</span> (fabsf(_att.yawspeed) &lt; HDG_HOLD_YAWRATE_THRESH &amp;&amp; !_yaw_lock_engaged) &#123;</span><br><span class="line">				<span class="comment">// little yaw movement, lock to current heading</span></span><br><span class="line">				_yaw_lock_engaged = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* user tries to do a takeoff in heading hold mode, reset the yaw setpoint on every iteration</span></span><br><span class="line"><span class="comment">			  to make sure the plane does not start rolling</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">			<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">				_hdg_hold_enabled = <span class="literal">false</span>;</span><br><span class="line">				_yaw_lock_engaged = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_yaw_lock_engaged) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* just switched back from non heading-hold to heading hold */</span></span><br><span class="line">				<span class="keyword">if</span> (!_hdg_hold_enabled) &#123;</span><br><span class="line">					_hdg_hold_enabled = <span class="literal">true</span>;</span><br><span class="line">					_hdg_hold_yaw = _yaw;</span><br><span class="line"></span><br><span class="line">					get_waypoint_heading_distance(_hdg_hold_yaw, _hdg_hold_prev_wp, _hdg_hold_curr_wp, <span class="literal">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* we have a valid heading hold position, are we too close? */</span></span><br><span class="line">				<span class="keyword">float</span> dist = get_distance_to_next_waypoint(_global_pos.lat, _global_pos.lon, _hdg_hold_curr_wp.lat,</span><br><span class="line">						_hdg_hold_curr_wp.lon);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (dist &lt; HDG_HOLD_REACHED_DIST) &#123;</span><br><span class="line">					get_waypoint_heading_distance(_hdg_hold_yaw, _hdg_hold_prev_wp, _hdg_hold_curr_wp, <span class="literal">false</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				Vector2f prev_wp&#123;(<span class="keyword">float</span>)_hdg_hold_prev_wp.lat, (<span class="keyword">float</span>)_hdg_hold_prev_wp.lon&#125;;</span><br><span class="line">				Vector2f curr_wp&#123;(<span class="keyword">float</span>)_hdg_hold_curr_wp.lat, (<span class="keyword">float</span>)_hdg_hold_curr_wp.lon&#125;;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* populate l1 control setpoint */</span></span><br><span class="line">				_l1_control.navigate_waypoints(prev_wp, curr_wp, curr_pos, ground_speed);</span><br><span class="line"></span><br><span class="line">				_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">				_att_sp.yaw_body = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">					<span class="comment">/* limit roll motion to ensure enough lift */</span></span><br><span class="line">					_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, radians(<span class="number">-15.0f</span>), radians(<span class="number">15.0f</span>));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!_yaw_lock_engaged || fabsf(_manual.y) &gt;= HDG_HOLD_MAN_INPUT_THRESH ||</span><br><span class="line">		    fabsf(_manual.r) &gt;= HDG_HOLD_MAN_INPUT_THRESH) &#123;</span><br><span class="line"></span><br><span class="line">			_hdg_hold_enabled = <span class="literal">false</span>;</span><br><span class="line">			_yaw_lock_engaged = <span class="literal">false</span>;</span><br><span class="line">			_att_sp.roll_body = _manual.y * _parameters.man_roll_max_rad;</span><br><span class="line">			_att_sp.yaw_body = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">//如果是手工的纯高度控制</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode.flag_control_altitude_enabled) &#123;</span><br><span class="line">		<span class="comment">/* ALTITUDE CONTROL: pitch stick moves altitude setpoint, throttle stick sets airspeed */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_control_mode_current != FW_POSCTRL_MODE_POSITION &amp;&amp; _control_mode_current != FW_POSCTRL_MODE_ALTITUDE) &#123;</span><br><span class="line">			<span class="comment">/* Need to init because last loop iteration was in a different mode */</span></span><br><span class="line">			_hold_alt = _global_pos.alt;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_ALTITUDE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Get demanded airspeed */</span></span><br><span class="line">		<span class="keyword">float</span> altctrl_airspeed = get_demanded_airspeed();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* update desired altitude based on user pitch stick input */</span></span><br><span class="line">		<span class="keyword">bool</span> climbout_requested = update_desired_altitude(dt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if we assume that user is taking off then help by demanding altitude setpoint well above ground</span></span><br><span class="line">		<span class="comment">// and set limit to pitch angle to prevent steering into ground</span></span><br><span class="line">		<span class="comment">// this will only affect planes and not VTOL</span></span><br><span class="line">		<span class="keyword">float</span> pitch_limit_min = _parameters.pitch_limit_min;</span><br><span class="line">		do_takeoff_help(&amp;_hold_alt, &amp;pitch_limit_min);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* throttle limiting */</span></span><br><span class="line">		throttle_max = _parameters.throttle_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_land_detected.landed &amp;&amp; (fabsf(_manual.z) &lt; THROTTLE_THRESH)) &#123;</span><br><span class="line">			throttle_max = <span class="number">0.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(_hold_alt,</span><br><span class="line">					   altctrl_airspeed,</span><br><span class="line">					   radians(_parameters.pitch_limit_min),</span><br><span class="line">					   radians(_parameters.pitch_limit_max),</span><br><span class="line">					   _parameters.throttle_min,</span><br><span class="line">					   throttle_max,</span><br><span class="line">					   _parameters.throttle_cruise,</span><br><span class="line">					   climbout_requested,</span><br><span class="line">					   climbout_requested ? radians(<span class="number">10.0f</span>) : pitch_limit_min,</span><br><span class="line">					   tecs_status_s::TECS_MODE_NORMAL);</span><br><span class="line"></span><br><span class="line">		_att_sp.roll_body = _manual.y * _parameters.man_roll_max_rad;</span><br><span class="line">		_att_sp.yaw_body = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果是手工，随性飞，既不控制高度，也不控制速度</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_OTHER;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* do not publish the setpoint */</span></span><br><span class="line">		setpoint = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// reset hold altitude</span></span><br><span class="line">		_hold_alt = _global_pos.alt;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset landing and takeoff state */</span></span><br><span class="line">		<span class="keyword">if</span> (!_last_manual) &#123;</span><br><span class="line">			reset_landing_state();</span><br><span class="line">			reset_takeoff_state();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//广播的相关事宜，和飞控关系不大</span></span><br><span class="line">	<span class="comment">/* Copy thrust output for publication */</span></span><br><span class="line">	<span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp; <span class="comment">// launchdetector only available in auto</span></span><br><span class="line">	    pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF &amp;&amp;</span><br><span class="line">	    _launch_detection_state != LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS &amp;&amp;</span><br><span class="line">	    !_runway_takeoff.runwayTakeoffEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* making sure again that the correct thrust is used,</span></span><br><span class="line"><span class="comment">		 * without depending on library calls for safety reasons.</span></span><br><span class="line"><span class="comment">		   the pre-takeoff throttle and the idle throttle normally map to the same parameter. */</span></span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = _parameters.throttle_idle;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp;</span><br><span class="line">		   pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF &amp;&amp;</span><br><span class="line">		   _runway_takeoff.runwayTakeoffEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = _runway_takeoff.getThrottle(<span class="built_in">min</span>(get_tecs_thrust(), throttle_max));</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp;</span><br><span class="line">		   pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_IDLE) &#123;</span><br><span class="line"></span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_OTHER) &#123;</span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = <span class="built_in">min</span>(_att_sp.thrust_body[<span class="number">0</span>], _parameters.throttle_max);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Copy thrust and pitch values from tecs */</span></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_land_detected.landed) &#123;</span><br><span class="line">			<span class="comment">// when we are landed state we want the motor to spin at idle speed</span></span><br><span class="line">			_att_sp.thrust_body[<span class="number">0</span>] = <span class="built_in">min</span>(_parameters.throttle_idle, throttle_max);</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			_att_sp.thrust_body[<span class="number">0</span>] = <span class="built_in">min</span>(get_tecs_thrust(), throttle_max);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// decide when to use pitch setpoint from TECS because in some cases pitch</span></span><br><span class="line">	<span class="comment">// setpoint is generated by other means</span></span><br><span class="line">    <span class="comment">//之前已经确定了输出的roll，yaw（通过L1）;Throttle（通过TECS），而还没有确定Pitch要不要用TECS的结果，下面是一个复杂的条件判断。</span></span><br><span class="line">	<span class="keyword">bool</span> use_tecs_pitch = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// auto runway takeoff</span></span><br><span class="line">	use_tecs_pitch &amp;= !(_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp;</span><br><span class="line">			    pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF &amp;&amp;</span><br><span class="line">			    (_launch_detection_state == LAUNCHDETECTION_RES_NONE || _runway_takeoff.runwayTakeoffEnabled()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// flaring during landing</span></span><br><span class="line">	use_tecs_pitch &amp;= !(pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_LAND &amp;&amp; _land_noreturn_vertical);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// manual attitude control</span></span><br><span class="line">	use_tecs_pitch &amp;= !(_control_mode_current == FW_POSCTRL_MODE_OTHER);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (use_tecs_pitch) &#123;</span><br><span class="line">		_att_sp.pitch_body = get_tecs_pitch();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_control_mode.flag_control_position_enabled) &#123;</span><br><span class="line">		_last_manual = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_last_manual = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> setpoint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-附录"><a href="#3-附录" class="headerlink" title="3. 附录"></a>3. 附录</h1><h2 id="3-1-头文件"><a href="#3-1-头文件" class="headerlink" title="3.1 头文件"></a>3.1 头文件</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   Copyright (c) 2013-2017 PX4 Development Team. All rights reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment"> * modification, are permitted provided that the following conditions</span></span><br><span class="line"><span class="comment"> * are met:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="comment"> *    notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span></span><br><span class="line"><span class="comment"> *    notice, this list of conditions and the following disclaimer in</span></span><br><span class="line"><span class="comment"> *    the documentation and/or other materials provided with the</span></span><br><span class="line"><span class="comment"> *    distribution.</span></span><br><span class="line"><span class="comment"> * 3. Neither the name PX4 nor the names of its contributors may be</span></span><br><span class="line"><span class="comment"> *    used to endorse or promote products derived from this software</span></span><br><span class="line"><span class="comment"> *    without specific prior written permission.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></span><br><span class="line"><span class="comment"> * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span></span><br><span class="line"><span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span></span><br><span class="line"><span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span></span><br><span class="line"><span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span></span><br><span class="line"><span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span></span><br><span class="line"><span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span></span><br><span class="line"><span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span></span><br><span class="line"><span class="comment"> * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></span><br><span class="line"><span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> ****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file fw_pos_control_l1_main.hpp</span></span><br><span class="line"><span class="comment"> * Implementation of a generic position controller based on the L1 norm. Outputs a bank / roll</span></span><br><span class="line"><span class="comment"> * angle, equivalent to a lateral motion (for copters and rovers).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The implementation for the controllers is in the ECL library. This class only</span></span><br><span class="line"><span class="comment"> * interfaces to the library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author Lorenz Meier &lt;lorenz@px4.io&gt;</span></span><br><span class="line"><span class="comment"> * @author Thomas Gubler &lt;thomasgubler@gmail.com&gt;</span></span><br><span class="line"><span class="comment"> * @author Andreas Antener &lt;andreas@uaventure.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FIXEDWINGPOSITIONCONTROL_HPP_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIXEDWINGPOSITIONCONTROL_HPP_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"launchdetection/LaunchDetector.h"</span> <span class="comment">//不同发射方式的自动检测</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"runway_takeoff/RunwayTakeoff.h"</span> <span class="comment">//带方向盘的固定翼无人机跑道起飞操纵</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;float.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//第三方库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;drivers/drv_hrt.h&gt; //提供微妙（us）级的精确计时，在中断上下文中调用，与其他函数并行执行不会被堵塞</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lib/ecl/geo/geo.h&gt; //执行测地线计算的地理/数学函数定义</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lib/ecl/l1/ecl_l1_pos_controller.h&gt; //提供L1控制的API</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lib/ecl/tecs/tecs.h&gt; //提供TECS控制的API</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lib/landing_slope/Landingslope.hpp&gt; //为固定翼着陆的角度变化模块</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lib/mathlib/mathlib.h&gt; //提供math命名空间下的constrain/max/min/radians等基础数学函数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lib/perf/perf_counter.h&gt; //性能测量库，perf_counter提供计时函数</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//PX4日常操作需要引用的库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;px4_config.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;px4_defines.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;px4_module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;px4_module_params.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;px4_posix.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;px4_tasks.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//uORB订阅所需要引用的库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/Subscription.hpp&gt;</span></span></span><br><span class="line"><span class="comment">//PX4官方给我们定义好的uORB消息类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/airspeed.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/manual_control_setpoint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/parameter_update.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/position_controller_landing_status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/position_controller_status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/position_setpoint_triplet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/sensor_baro.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/sensor_bias.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/tecs_status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_attitude.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_attitude_setpoint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_command.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_control_mode.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_global_position.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_land_detected.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_local_position.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/topics/vehicle_status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uORB/uORB.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//VTOL机型需要的库，雨我无瓜</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vtol_att_control/vtol_type.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//来自&lt;lib/mathlib/mathlib.h&gt;的基础数学函数</span></span><br><span class="line"><span class="keyword">using</span> math::<span class="built_in">constrain</span>;<span class="comment">//输入一个值，和一个上下限，如果第一个值在限定域以内，就返回离它近的上下限的值</span></span><br><span class="line"><span class="keyword">using</span> math::<span class="built_in">max</span>;</span><br><span class="line"><span class="keyword">using</span> math::<span class="built_in">min</span>;</span><br><span class="line"><span class="keyword">using</span> math::radians;<span class="comment">//执行 角度-》弧度 的转换，输入角度，输出弧度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//来自&lt;lib/matrix/xxx.h&gt;，提供存储矩阵的容器</span></span><br><span class="line"><span class="keyword">using</span> matrix::Dcmf;<span class="comment">//方向余弦矩阵(DCM)，由欧拉角或四元数得到，描述飞机的姿态</span></span><br><span class="line"><span class="keyword">using</span> matrix::Eulerf;<span class="comment">//存欧拉角的三维向量</span></span><br><span class="line"><span class="keyword">using</span> matrix::Quatf;<span class="comment">//存四元数的四维向量</span></span><br><span class="line"><span class="keyword">using</span> matrix::Vector2f;<span class="comment">//二维向量</span></span><br><span class="line"><span class="keyword">using</span> matrix::Vector3f;<span class="comment">//三维向量</span></span><br><span class="line"><span class="keyword">using</span> matrix::wrap_pi;<span class="comment">//把弧度调到（0,2pi）区间来</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> uORB::Subscription;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> launchdetection;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> runwaytakeoff;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> time_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">//航向控制模式下的一些参数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> HDG_HOLD_DIST_NEXT =</span><br><span class="line">	<span class="number">3000.0f</span>; <span class="comment">// initial distance of waypoint in front of plane in heading hold mode</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> HDG_HOLD_REACHED_DIST =</span><br><span class="line">	<span class="number">1000.0f</span>; <span class="comment">// distance (plane to waypoint in front) at which waypoints are reset in heading hold mode</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> HDG_HOLD_SET_BACK_DIST = <span class="number">100.0f</span>; <span class="comment">// distance by which previous waypoint is set behind the plane</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> HDG_HOLD_YAWRATE_THRESH = <span class="number">0.15f</span>;	<span class="comment">// max yawrate at which plane locks yaw for heading hold mode</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> HDG_HOLD_MAN_INPUT_THRESH =</span><br><span class="line">	<span class="number">0.01f</span>; <span class="comment">// max manual roll/yaw input from user which does not change the locked heading</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> hrt_abstime T_ALT_TIMEOUT = <span class="number">1</span>_s; <span class="comment">// time after which we abort landing if terrain estimate is not valid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//一些阈值参数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> THROTTLE_THRESH =</span><br><span class="line">	<span class="number">0.05f</span>;	<span class="comment">///&lt; max throttle from user which will not lead to motors spinning up in altitude controlled modes</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> MANUAL_THROTTLE_CLIMBOUT_THRESH =</span><br><span class="line">	<span class="number">0.85f</span>; <span class="comment">///&lt; a throttle / pitch input above this value leads to the system switching to climbout mode</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">float</span> ALTHOLD_EPV_RESET_THRESH = <span class="number">5.0f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//固定翼位置控制FixedwingPositionControl类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FixedwingPositionControl</span> <span class="title">final</span> :</span> <span class="keyword">public</span> ModuleBase&lt;FixedwingPositionControl&gt;, <span class="keyword">public</span> ModuleParams</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// public下是一些成员函数</span></span><br><span class="line">    FixedwingPositionControl();<span class="comment">//构造函数，先初始化了_parameter_handles里面所有参数的句柄，然后执行了一次参数更新parameters_update()</span></span><br><span class="line">    ~FixedwingPositionControl() <span class="keyword">override</span>;<span class="comment">//析构函数被重载</span></span><br><span class="line">	FixedwingPositionControl(<span class="keyword">const</span> FixedwingPositionControl &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	FixedwingPositionControl <span class="keyword">operator</span>=(<span class="keyword">const</span> FixedwingPositionControl &amp;other) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fw_pos_control_l1模块的一些命令行操作，继承自ModuleBase</span></span><br><span class="line">	<span class="comment">/** @see ModuleBase */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">task_spawn</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** @see ModuleBase */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> FixedwingPositionControl *<span class="title">instantiate</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** @see ModuleBase */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">custom_command</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** @see ModuleBase */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">print_usage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *reason = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** @see ModuleBase::run() */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;<span class="comment">//run函数是该类的主要运行函数，被重载</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/** @see ModuleBase::print_status() */</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">print_status</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//private下是一堆变量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//飞行状态量的pub句柄</span></span><br><span class="line">	<span class="keyword">orb_advert_t</span>	_mavlink_log_pub&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="keyword">orb_advert_t</span>	_attitude_sp_pub&#123;<span class="literal">nullptr</span>&#125;;		<span class="comment">///&lt; attitude setpoint */</span></span><br><span class="line">    <span class="keyword">orb_advert_t</span>	_pos_ctrl_status_pub&#123;<span class="literal">nullptr</span>&#125;;		<span class="comment">///&lt; navigation capabilities publication */</span></span><br><span class="line">    <span class="keyword">orb_advert_t</span>	_pos_ctrl_landing_status_pub&#123;<span class="literal">nullptr</span>&#125;;	<span class="comment">///&lt; landing status publication */</span></span><br><span class="line">    <span class="keyword">orb_advert_t</span>	_tecs_status_pub&#123;<span class="literal">nullptr</span>&#125;;		<span class="comment">///&lt; TECS status publication */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//飞行状态量的sub句柄</span></span><br><span class="line">	<span class="keyword">int</span>		_global_pos_sub&#123;<span class="number">-1</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span>		_local_pos_sub&#123;<span class="number">-1</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span>		_pos_sp_triplet_sub&#123;<span class="number">-1</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span>		_control_mode_sub&#123;<span class="number">-1</span>&#125;;			<span class="comment">///&lt; control mode subscription */</span></span><br><span class="line">	<span class="keyword">int</span>		_vehicle_attitude_sub&#123;<span class="number">-1</span>&#125;;		<span class="comment">///&lt; vehicle attitude subscription */</span></span><br><span class="line">	<span class="keyword">int</span>		_vehicle_command_sub&#123;<span class="number">-1</span>&#125;;		<span class="comment">///&lt; vehicle command subscription */</span></span><br><span class="line">	<span class="keyword">int</span>		_vehicle_status_sub&#123;<span class="number">-1</span>&#125;;		<span class="comment">///&lt; vehicle status subscription */</span></span><br><span class="line">	<span class="keyword">int</span>		_vehicle_land_detected_sub&#123;<span class="number">-1</span>&#125;;		<span class="comment">///&lt; vehicle land detected subscription */</span></span><br><span class="line">	<span class="keyword">int</span>		_params_sub&#123;<span class="number">-1</span>&#125;;			<span class="comment">///&lt; notification of parameter updates */</span></span><br><span class="line">	<span class="keyword">int</span>		_manual_control_sub&#123;<span class="number">-1</span>&#125;;		<span class="comment">///&lt; notification of manual control updates */</span></span><br><span class="line">	<span class="keyword">int</span>		_sensor_baro_sub&#123;<span class="number">-1</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">orb_id_t</span> _attitude_setpoint_id&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储各种飞行状态量的容器</span></span><br><span class="line">	manual_control_setpoint_s	_manual &#123;&#125;;			<span class="comment">///&lt; r/c channel data */</span></span><br><span class="line">	position_setpoint_triplet_s	_pos_sp_triplet &#123;&#125;;		<span class="comment">///&lt; triplet of mission items */</span></span><br><span class="line">	vehicle_attitude_s	_att &#123;&#125;;			<span class="comment">///&lt; vehicle attitude setpoint */</span></span><br><span class="line">	vehicle_attitude_setpoint_s	_att_sp &#123;&#125;;			<span class="comment">///&lt; vehicle attitude setpoint */</span></span><br><span class="line">	vehicle_command_s		_vehicle_command &#123;&#125;;		<span class="comment">///&lt; vehicle commands */</span></span><br><span class="line">	vehicle_control_mode_s		_control_mode &#123;&#125;;		<span class="comment">///&lt; control mode */</span></span><br><span class="line">	vehicle_global_position_s	_global_pos &#123;&#125;;			<span class="comment">///&lt; global vehicle position */</span></span><br><span class="line">	vehicle_local_position_s	_local_pos &#123;&#125;;			<span class="comment">///&lt; vehicle local position */</span></span><br><span class="line">	vehicle_land_detected_s		_vehicle_land_detected &#123;&#125;;	<span class="comment">///&lt; vehicle land detected */</span></span><br><span class="line">	vehicle_status_s		_vehicle_status &#123;&#125;;		<span class="comment">///&lt; vehicle status */</span></span><br><span class="line"></span><br><span class="line">	Subscription&lt;airspeed_s&gt; _sub_airspeed;</span><br><span class="line">	Subscription&lt;sensor_bias_s&gt; _sub_sensors;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">perf_counter_t</span>	_loop_perf;				<span class="comment">///&lt; loop performance counter */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span>	_hold_alt&#123;<span class="number">0.0f</span>&#125;;				<span class="comment">///&lt; hold altitude for altitude mode */</span></span><br><span class="line">	<span class="keyword">float</span>	_takeoff_ground_alt&#123;<span class="number">0.0f</span>&#125;;			<span class="comment">///&lt; ground altitude at which plane was launched */</span></span><br><span class="line">	<span class="keyword">float</span>	_hdg_hold_yaw&#123;<span class="number">0.0f</span>&#125;;				<span class="comment">///&lt; hold heading for velocity mode */</span></span><br><span class="line">	<span class="keyword">bool</span>	_hdg_hold_enabled&#123;<span class="literal">false</span>&#125;;			<span class="comment">///&lt; heading hold enabled */</span></span><br><span class="line">	<span class="keyword">bool</span>	_yaw_lock_engaged&#123;<span class="literal">false</span>&#125;;			<span class="comment">///&lt; yaw is locked for heading hold */</span></span><br><span class="line">	<span class="keyword">float</span>	_althold_epv&#123;<span class="number">0.0f</span>&#125;;				<span class="comment">///&lt; the position estimate accuracy when engaging alt hold */</span></span><br><span class="line">	<span class="keyword">bool</span>	_was_in_deadband&#123;<span class="literal">false</span>&#125;;			<span class="comment">///&lt; wether the last stick input was in althold deadband */</span></span><br><span class="line"></span><br><span class="line">	position_setpoint_s _hdg_hold_prev_wp &#123;&#125;;		<span class="comment">///&lt; position where heading hold started */</span></span><br><span class="line">	position_setpoint_s _hdg_hold_curr_wp &#123;&#125;;		<span class="comment">///&lt; position to which heading hold flies */</span></span><br><span class="line"></span><br><span class="line">	hrt_abstime _control_position_last_called&#123;<span class="number">0</span>&#125;;		<span class="comment">///&lt; last call of control_position  */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Landing */</span></span><br><span class="line">	<span class="keyword">bool</span> _land_noreturn_horizontal&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">	<span class="keyword">bool</span> _land_noreturn_vertical&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">	<span class="keyword">bool</span> _land_stayonground&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">	<span class="keyword">bool</span> _land_motor_lim&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">	<span class="keyword">bool</span> _land_onslope&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">	<span class="keyword">bool</span> _land_abort&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line">	Landingslope _landingslope;</span><br><span class="line"></span><br><span class="line">	hrt_abstime _time_started_landing&#123;<span class="number">0</span>&#125;;			<span class="comment">///&lt; time at which landing started */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> _t_alt_prev_valid&#123;<span class="number">0</span>&#125;;				<span class="comment">///&lt; last terrain estimate which was valid */</span></span><br><span class="line">	hrt_abstime _time_last_t_alt&#123;<span class="number">0</span>&#125;;			<span class="comment">///&lt; time at which we had last valid terrain alt */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> _flare_height&#123;<span class="number">0.0f</span>&#125;;				<span class="comment">///&lt; estimated height to ground at which flare started */</span></span><br><span class="line">	<span class="keyword">float</span> _flare_pitch_sp&#123;<span class="number">0.0f</span>&#125;;			<span class="comment">///&lt; Current forced (i.e. not determined using TECS) flare pitch setpoint */</span></span><br><span class="line">	<span class="keyword">float</span> _flare_curve_alt_rel_last&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">	<span class="keyword">float</span> _target_bearing&#123;<span class="number">0.0f</span>&#125;;				<span class="comment">///&lt; estimated height to ground at which flare started */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> _was_in_air&#123;<span class="literal">false</span>&#125;;				<span class="comment">///&lt; indicated wether the plane was in the air in the previous interation*/</span></span><br><span class="line">	hrt_abstime _time_went_in_air&#123;<span class="number">0</span>&#125;;			<span class="comment">///&lt; time at which the plane went in the air */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Takeoff launch detection and runway */</span></span><br><span class="line">	LaunchDetector _launchDetector;</span><br><span class="line">	LaunchDetectionResult _launch_detection_state&#123;LAUNCHDETECTION_RES_NONE&#125;;</span><br><span class="line">	hrt_abstime _launch_detection_notify&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	RunwayTakeoff _runway_takeoff;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> _last_manual&#123;<span class="literal">false</span>&#125;;				<span class="comment">///&lt; true if the last iteration was in manual mode (used to determine when a reset is needed)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* throttle and airspeed states */</span></span><br><span class="line">	<span class="keyword">bool</span> _airspeed_valid&#123;<span class="literal">false</span>&#125;;				<span class="comment">///&lt; flag if a valid airspeed estimate exists</span></span><br><span class="line">	hrt_abstime _airspeed_last_valid&#123;<span class="number">0</span>&#125;;			<span class="comment">///&lt; last time airspeed was received. Used to detect timeouts.</span></span><br><span class="line">	<span class="keyword">float</span> _airspeed&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">	<span class="keyword">float</span> _eas2tas&#123;<span class="number">1.0f</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> _groundspeed_undershoot&#123;<span class="number">0.0f</span>&#125;;			<span class="comment">///&lt; ground speed error to min. speed in m/s</span></span><br><span class="line"></span><br><span class="line">	Dcmf _R_nb;				<span class="comment">///&lt; current attitude</span></span><br><span class="line">	<span class="keyword">float</span> _roll&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">	<span class="keyword">float</span> _pitch&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">	<span class="keyword">float</span> _yaw&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> _reinitialize_tecs&#123;<span class="literal">true</span>&#125;;				<span class="comment">///&lt; indicates if the TECS states should be reinitialized (used for VTOL)</span></span><br><span class="line">	<span class="keyword">bool</span> _is_tecs_running&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">	hrt_abstime _last_tecs_update&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> _asp_after_transition&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">	<span class="keyword">bool</span> _was_in_transition&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// estimator reset counters</span></span><br><span class="line">	<span class="keyword">uint8_t</span> _pos_reset_counter&#123;<span class="number">0</span>&#125;;				<span class="comment">///&lt; captures the number of times the estimator has reset the horizontal position</span></span><br><span class="line">	<span class="keyword">uint8_t</span> _alt_reset_counter&#123;<span class="number">0</span>&#125;;				<span class="comment">///&lt; captures the number of times the estimator has reset the altitude state</span></span><br><span class="line"></span><br><span class="line">    ECL_L1_Pos_Controller _l1_control;</span><br><span class="line">    TECS _tecs;</span><br><span class="line">    <span class="comment">//下面的枚举用于存储飞行模式</span></span><br><span class="line">	<span class="keyword">enum</span> FW_POSCTRL_MODE &#123;</span><br><span class="line">		FW_POSCTRL_MODE_AUTO,</span><br><span class="line">		FW_POSCTRL_MODE_POSITION,</span><br><span class="line">		FW_POSCTRL_MODE_ALTITUDE,</span><br><span class="line">		FW_POSCTRL_MODE_OTHER</span><br><span class="line">	&#125; _control_mode_current&#123;FW_POSCTRL_MODE_OTHER&#125;;		<span class="comment">///&lt; used to check the mode in the last control loop iteration. Use to check if the last iteration was in the same mode.</span></span><br><span class="line">    <span class="comment">//下面结构体用于实际存储飞控参数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">float</span> climbout_diff;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> max_climb_rate;</span><br><span class="line">		<span class="keyword">float</span> max_sink_rate;</span><br><span class="line">		<span class="keyword">float</span> speed_weight;</span><br><span class="line">		<span class="keyword">float</span> time_const_throt;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> airspeed_min;</span><br><span class="line">		<span class="keyword">float</span> airspeed_trim;</span><br><span class="line">		<span class="keyword">float</span> airspeed_max;</span><br><span class="line">		<span class="keyword">int32_t</span> airspeed_disabled;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> pitch_limit_min;</span><br><span class="line">		<span class="keyword">float</span> pitch_limit_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> throttle_min;</span><br><span class="line">		<span class="keyword">float</span> throttle_max;</span><br><span class="line">		<span class="keyword">float</span> throttle_idle;</span><br><span class="line">		<span class="keyword">float</span> throttle_cruise;</span><br><span class="line">		<span class="keyword">float</span> throttle_alt_scale;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> man_roll_max_rad;</span><br><span class="line">		<span class="keyword">float</span> man_pitch_max_rad;</span><br><span class="line">		<span class="keyword">float</span> rollsp_offset_rad;</span><br><span class="line">		<span class="keyword">float</span> pitchsp_offset_rad;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> throttle_land_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> land_heading_hold_horizontal_distance;</span><br><span class="line">		<span class="keyword">float</span> land_flare_pitch_min_deg;</span><br><span class="line">		<span class="keyword">float</span> land_flare_pitch_max_deg;</span><br><span class="line">		<span class="keyword">int32_t</span> land_use_terrain_estimate;</span><br><span class="line">		<span class="keyword">int32_t</span> land_early_config_change;</span><br><span class="line">		<span class="keyword">float</span> land_airspeed_scale;</span><br><span class="line">		<span class="keyword">float</span> land_throtTC_scale;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// VTOL</span></span><br><span class="line">		<span class="keyword">float</span> airspeed_trans;</span><br><span class="line">		<span class="keyword">int32_t</span> vtol_type;</span><br><span class="line">	&#125; _parameters&#123;&#125;;					<span class="comment">///&lt; local copies of interesting parameters */</span></span><br><span class="line">    <span class="comment">//下面的结构体用于存储飞控参数句柄</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">param_t</span> climbout_diff;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> l1_period;</span><br><span class="line">		<span class="keyword">param_t</span> l1_damping;</span><br><span class="line">		<span class="keyword">param_t</span> roll_limit;</span><br><span class="line">		<span class="keyword">param_t</span> roll_slew_deg_sec;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> time_const;</span><br><span class="line">		<span class="keyword">param_t</span> time_const_throt;</span><br><span class="line">		<span class="keyword">param_t</span> min_sink_rate;</span><br><span class="line">		<span class="keyword">param_t</span> max_sink_rate;</span><br><span class="line">		<span class="keyword">param_t</span> max_climb_rate;</span><br><span class="line">		<span class="keyword">param_t</span> heightrate_p;</span><br><span class="line">		<span class="keyword">param_t</span> heightrate_ff;</span><br><span class="line">		<span class="keyword">param_t</span> speedrate_p;</span><br><span class="line">		<span class="keyword">param_t</span> throttle_damp;</span><br><span class="line">		<span class="keyword">param_t</span> integrator_gain;</span><br><span class="line">		<span class="keyword">param_t</span> vertical_accel_limit;</span><br><span class="line">		<span class="keyword">param_t</span> height_comp_filter_omega;</span><br><span class="line">		<span class="keyword">param_t</span> speed_comp_filter_omega;</span><br><span class="line">		<span class="keyword">param_t</span> roll_throttle_compensation;</span><br><span class="line">		<span class="keyword">param_t</span> speed_weight;</span><br><span class="line">		<span class="keyword">param_t</span> pitch_damping;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> airspeed_min;</span><br><span class="line">		<span class="keyword">param_t</span> airspeed_trim;</span><br><span class="line">		<span class="keyword">param_t</span> airspeed_max;</span><br><span class="line">		<span class="keyword">param_t</span> airspeed_trans;</span><br><span class="line">		<span class="keyword">param_t</span> airspeed_disabled;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> pitch_limit_min;</span><br><span class="line">		<span class="keyword">param_t</span> pitch_limit_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> throttle_min;</span><br><span class="line">		<span class="keyword">param_t</span> throttle_max;</span><br><span class="line">		<span class="keyword">param_t</span> throttle_idle;</span><br><span class="line">		<span class="keyword">param_t</span> throttle_cruise;</span><br><span class="line">		<span class="keyword">param_t</span> throttle_slew_max;</span><br><span class="line">		<span class="keyword">param_t</span> throttle_alt_scale;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> man_roll_max_deg;</span><br><span class="line">		<span class="keyword">param_t</span> man_pitch_max_deg;</span><br><span class="line">		<span class="keyword">param_t</span> rollsp_offset_deg;</span><br><span class="line">		<span class="keyword">param_t</span> pitchsp_offset_deg;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> throttle_land_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> land_slope_angle;</span><br><span class="line">		<span class="keyword">param_t</span> land_H1_virt;</span><br><span class="line">		<span class="keyword">param_t</span> land_flare_alt_relative;</span><br><span class="line">		<span class="keyword">param_t</span> land_thrust_lim_alt_relative;</span><br><span class="line">		<span class="keyword">param_t</span> land_heading_hold_horizontal_distance;</span><br><span class="line">		<span class="keyword">param_t</span> land_flare_pitch_min_deg;</span><br><span class="line">		<span class="keyword">param_t</span> land_flare_pitch_max_deg;</span><br><span class="line">		<span class="keyword">param_t</span> land_use_terrain_estimate;</span><br><span class="line">		<span class="keyword">param_t</span> land_early_config_change;</span><br><span class="line">		<span class="keyword">param_t</span> land_airspeed_scale;</span><br><span class="line">		<span class="keyword">param_t</span> land_throtTC_scale;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">param_t</span> vtol_type;</span><br><span class="line">	&#125; _parameter_handles &#123;&#125;;				<span class="comment">///&lt; handles for interesting parameters */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//public里也有成员函数</span></span><br><span class="line">	<span class="comment">// Update our local parameter cache.</span></span><br><span class="line">    <span class="comment">// 更新了所有的参数，把句柄里param_get(_parameter_handles.airspeed_min, &amp;(_parameters.airspeed_min));</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span>	<span class="title">parameters_update</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update subscriptions</span></span><br><span class="line">    <span class="comment">//更新订阅，得到最新的状态量</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">airspeed_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">control_update</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">manual_control_setpoint_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">position_setpoint_triplet_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vehicle_attitude_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vehicle_command_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vehicle_control_mode_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vehicle_land_detected_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vehicle_status_poll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//发布消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">status_publish</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">landing_status_publish</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">tecs_status_publish</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//放弃降落</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">abort_landing</span><span class="params">(<span class="keyword">bool</span> <span class="built_in">abort</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Get a new waypoint based on heading and distance from current position</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param heading the heading to fly to</span></span><br><span class="line"><span class="comment">	 * @param distance the distance of the generated waypoint</span></span><br><span class="line"><span class="comment">	 * @param waypoint_prev the waypoint at the current position</span></span><br><span class="line"><span class="comment">	 * @param waypoint_next the waypoint in the heading direction</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//计算下一个路径点</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_waypoint_heading_distance</span><span class="params">(<span class="keyword">float</span> heading, position_setpoint_s &amp;waypoint_prev,</span></span></span><br><span class="line"><span class="function"><span class="params">			position_setpoint_s &amp;waypoint_next, <span class="keyword">bool</span> flag_init)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the terrain estimate during takeoff or takeoff_alt if terrain estimate is not available</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//如果地形估计不可用，在起飞时返回地形估计</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">get_terrain_altitude_takeoff</span><span class="params">(<span class="keyword">float</span> takeoff_alt, <span class="keyword">const</span> vehicle_global_position_s &amp;global_pos)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Check if we are in a takeoff situation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//检查是否在起飞模式</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">in_takeoff_situation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Do takeoff help when in altitude controlled modes</span></span><br><span class="line"><span class="comment">	 * @param hold_altitude altitude setpoint for controller</span></span><br><span class="line"><span class="comment">	 * @param pitch_limit_min minimum pitch allowed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">do_takeoff_help</span><span class="params">(<span class="keyword">float</span> *hold_altitude, <span class="keyword">float</span> *pitch_limit_min)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Update desired altitude base on user pitch stick input</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param dt Time step</span></span><br><span class="line"><span class="comment">	 * @return true if climbout mode was requested by user (climb with max rate and min airspeed)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//计算_hold_alt，如果用户请求爬升模式（以最大速度和最小空速爬升），则返回true。</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">update_desired_altitude</span><span class="params">(<span class="keyword">float</span> dt)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//控制位置、起飞、降落的顶层函数</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">control_position</span><span class="params">(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev,</span></span></span><br><span class="line"><span class="function"><span class="params">					 <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_next)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">control_takeoff</span><span class="params">(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev,</span></span></span><br><span class="line"><span class="function"><span class="params">					<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">control_landing</span><span class="params">(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev,</span></span></span><br><span class="line"><span class="function"><span class="params">					<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr)</span></span>;</span><br><span class="line">    <span class="comment">//调用tecs的API，获取爬升角和油门的setpoint</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">get_tecs_pitch</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">get_tecs_thrust</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过tecs系统，控制飞机达到想要的速度，用于在手动控制时</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">get_demanded_airspeed</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据想要的速度和地面速度，判断想要的速度是否可行，如果不可行会返回一个修正后的值,否则返回原来的值</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">calculate_target_airspeed</span><span class="params">(<span class="keyword">float</span> airspeed_demand)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">calculate_gndspeed_undershoot</span><span class="params">(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Handle incoming vehicle commands</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span>		<span class="title">handle_command</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span>		<span class="title">reset_takeoff_state</span><span class="params">(<span class="keyword">bool</span> force = <span class="literal">false</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span>		<span class="title">reset_landing_state</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Call TECS : a wrapper function to call the TECS implementation</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//和TECS库API接触的底层函数</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">tecs_update_pitch_throttle</span><span class="params">(<span class="keyword">float</span> alt_sp, <span class="keyword">float</span> airspeed_sp,</span></span></span><br><span class="line"><span class="function"><span class="params">					<span class="keyword">float</span> pitch_min_rad, <span class="keyword">float</span> pitch_max_rad,</span></span></span><br><span class="line"><span class="function"><span class="params">					<span class="keyword">float</span> throttle_min, <span class="keyword">float</span> throttle_max, <span class="keyword">float</span> throttle_cruise,</span></span></span><br><span class="line"><span class="function"><span class="params">					<span class="keyword">bool</span> climbout_mode, <span class="keyword">float</span> climbout_pitch_min_rad,</span></span></span><br><span class="line"><span class="function"><span class="params">					<span class="keyword">uint8_t</span> mode = tecs_status_s::TECS_MODE_NORMAL)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// FIXEDWINGPOSITIONCONTROL_HPP_</span></span></span><br></pre></td></tr></table></figure>
<h2 id="3-2-源文件"><a href="#3-2-源文件" class="headerlink" title="3.2 源文件"></a>3.2 源文件</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br><span class="line">2080</span><br><span class="line">2081</span><br><span class="line">2082</span><br><span class="line">2083</span><br><span class="line">2084</span><br><span class="line">2085</span><br><span class="line">2086</span><br><span class="line">2087</span><br><span class="line">2088</span><br><span class="line">2089</span><br><span class="line">2090</span><br><span class="line">2091</span><br><span class="line">2092</span><br><span class="line">2093</span><br><span class="line">2094</span><br><span class="line">2095</span><br><span class="line">2096</span><br><span class="line">2097</span><br><span class="line">2098</span><br><span class="line">2099</span><br><span class="line">2100</span><br><span class="line">2101</span><br><span class="line">2102</span><br><span class="line">2103</span><br><span class="line">2104</span><br><span class="line">2105</span><br><span class="line">2106</span><br><span class="line">2107</span><br><span class="line">2108</span><br><span class="line">2109</span><br><span class="line">2110</span><br><span class="line">2111</span><br><span class="line">2112</span><br><span class="line">2113</span><br><span class="line">2114</span><br><span class="line">2115</span><br><span class="line">2116</span><br><span class="line">2117</span><br><span class="line">2118</span><br><span class="line">2119</span><br><span class="line">2120</span><br><span class="line">2121</span><br><span class="line">2122</span><br><span class="line">2123</span><br><span class="line">2124</span><br><span class="line">2125</span><br><span class="line">2126</span><br><span class="line">2127</span><br><span class="line">2128</span><br><span class="line">2129</span><br><span class="line">2130</span><br><span class="line">2131</span><br><span class="line">2132</span><br><span class="line">2133</span><br><span class="line">2134</span><br><span class="line">2135</span><br><span class="line">2136</span><br><span class="line">2137</span><br><span class="line">2138</span><br><span class="line">2139</span><br><span class="line">2140</span><br><span class="line">2141</span><br><span class="line">2142</span><br><span class="line">2143</span><br><span class="line">2144</span><br><span class="line">2145</span><br><span class="line">2146</span><br><span class="line">2147</span><br><span class="line">2148</span><br><span class="line">2149</span><br><span class="line">2150</span><br><span class="line">2151</span><br><span class="line">2152</span><br><span class="line">2153</span><br><span class="line">2154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   Copyright (c) 2013-2017 PX4 Development Team. All rights reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment"> * modification, are permitted provided that the following conditions</span></span><br><span class="line"><span class="comment"> * are met:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="comment"> *    notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span></span><br><span class="line"><span class="comment"> *    notice, this list of conditions and the following disclaimer in</span></span><br><span class="line"><span class="comment"> *    the documentation and/or other materials provided with the</span></span><br><span class="line"><span class="comment"> *    distribution.</span></span><br><span class="line"><span class="comment"> * 3. Neither the name PX4 nor the names of its contributors may be</span></span><br><span class="line"><span class="comment"> *    used to endorse or promote products derived from this software</span></span><br><span class="line"><span class="comment"> *    without specific prior written permission.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></span><br><span class="line"><span class="comment"> * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span></span><br><span class="line"><span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span></span><br><span class="line"><span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span></span><br><span class="line"><span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span></span><br><span class="line"><span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span></span><br><span class="line"><span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span></span><br><span class="line"><span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span></span><br><span class="line"><span class="comment"> * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></span><br><span class="line"><span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> ****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"FixedwingPositionControl.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">__EXPORT <span class="keyword">int</span> <span class="title">fw_pos_control_l1_main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造函数，读取了飞行参数</span></span><br><span class="line">FixedwingPositionControl::FixedwingPositionControl() :</span><br><span class="line">	ModuleParams(<span class="literal">nullptr</span>),</span><br><span class="line">	_sub_airspeed(ORB_ID(airspeed)),</span><br><span class="line">	_sub_sensors(ORB_ID(sensor_bias)),</span><br><span class="line">	_loop_perf(perf_alloc(PC_ELAPSED, <span class="string">"fw_l1_control"</span>)),</span><br><span class="line">	_launchDetector(<span class="keyword">this</span>),</span><br><span class="line">	_runway_takeoff(<span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">	_parameter_handles.l1_period = param_find(<span class="string">"FW_L1_PERIOD"</span>);</span><br><span class="line">	_parameter_handles.l1_damping = param_find(<span class="string">"FW_L1_DAMPING"</span>);</span><br><span class="line">	_parameter_handles.roll_slew_deg_sec = param_find(<span class="string">"FW_L1_R_SLEW_MAX"</span>);</span><br><span class="line"></span><br><span class="line">	_parameter_handles.airspeed_min = param_find(<span class="string">"FW_AIRSPD_MIN"</span>);</span><br><span class="line">	_parameter_handles.airspeed_trim = param_find(<span class="string">"FW_AIRSPD_TRIM"</span>);</span><br><span class="line">	_parameter_handles.airspeed_max = param_find(<span class="string">"FW_AIRSPD_MAX"</span>);</span><br><span class="line">	_parameter_handles.airspeed_disabled = param_find(<span class="string">"FW_ARSP_MODE"</span>);</span><br><span class="line"></span><br><span class="line">	_parameter_handles.pitch_limit_min = param_find(<span class="string">"FW_P_LIM_MIN"</span>);</span><br><span class="line">	_parameter_handles.pitch_limit_max = param_find(<span class="string">"FW_P_LIM_MAX"</span>);</span><br><span class="line">	_parameter_handles.roll_limit = param_find(<span class="string">"FW_R_LIM"</span>);</span><br><span class="line">	_parameter_handles.throttle_min = param_find(<span class="string">"FW_THR_MIN"</span>);</span><br><span class="line">	_parameter_handles.throttle_max = param_find(<span class="string">"FW_THR_MAX"</span>);</span><br><span class="line">	_parameter_handles.throttle_idle = param_find(<span class="string">"FW_THR_IDLE"</span>);</span><br><span class="line">	_parameter_handles.throttle_slew_max = param_find(<span class="string">"FW_THR_SLEW_MAX"</span>);</span><br><span class="line">	_parameter_handles.throttle_cruise = param_find(<span class="string">"FW_THR_CRUISE"</span>);</span><br><span class="line">	_parameter_handles.throttle_alt_scale = param_find(<span class="string">"FW_THR_ALT_SCL"</span>);</span><br><span class="line">	_parameter_handles.throttle_land_max = param_find(<span class="string">"FW_THR_LND_MAX"</span>);</span><br><span class="line">	_parameter_handles.man_roll_max_deg = param_find(<span class="string">"FW_MAN_R_MAX"</span>);</span><br><span class="line">	_parameter_handles.man_pitch_max_deg = param_find(<span class="string">"FW_MAN_P_MAX"</span>);</span><br><span class="line">	_parameter_handles.rollsp_offset_deg = param_find(<span class="string">"FW_RSP_OFF"</span>);</span><br><span class="line">	_parameter_handles.pitchsp_offset_deg = param_find(<span class="string">"FW_PSP_OFF"</span>);</span><br><span class="line"></span><br><span class="line">	_parameter_handles.land_slope_angle = param_find(<span class="string">"FW_LND_ANG"</span>);</span><br><span class="line">	_parameter_handles.land_H1_virt = param_find(<span class="string">"FW_LND_HVIRT"</span>);</span><br><span class="line">	_parameter_handles.land_flare_alt_relative = param_find(<span class="string">"FW_LND_FLALT"</span>);</span><br><span class="line">	_parameter_handles.land_flare_pitch_min_deg = param_find(<span class="string">"FW_LND_FL_PMIN"</span>);</span><br><span class="line">	_parameter_handles.land_flare_pitch_max_deg = param_find(<span class="string">"FW_LND_FL_PMAX"</span>);</span><br><span class="line">	_parameter_handles.land_thrust_lim_alt_relative = param_find(<span class="string">"FW_LND_TLALT"</span>);</span><br><span class="line">	_parameter_handles.land_heading_hold_horizontal_distance = param_find(<span class="string">"FW_LND_HHDIST"</span>);</span><br><span class="line">	_parameter_handles.land_use_terrain_estimate = param_find(<span class="string">"FW_LND_USETER"</span>);</span><br><span class="line">	_parameter_handles.land_early_config_change = param_find(<span class="string">"FW_LND_EARLYCFG"</span>);</span><br><span class="line">	_parameter_handles.land_airspeed_scale = param_find(<span class="string">"FW_LND_AIRSPD_SC"</span>);</span><br><span class="line">	_parameter_handles.land_throtTC_scale = param_find(<span class="string">"FW_LND_THRTC_SC"</span>);</span><br><span class="line"></span><br><span class="line">	_parameter_handles.time_const = param_find(<span class="string">"FW_T_TIME_CONST"</span>);</span><br><span class="line">	_parameter_handles.time_const_throt = param_find(<span class="string">"FW_T_THRO_CONST"</span>);</span><br><span class="line">	_parameter_handles.min_sink_rate = param_find(<span class="string">"FW_T_SINK_MIN"</span>);</span><br><span class="line">	_parameter_handles.max_sink_rate = param_find(<span class="string">"FW_T_SINK_MAX"</span>);</span><br><span class="line">	_parameter_handles.max_climb_rate = param_find(<span class="string">"FW_T_CLMB_MAX"</span>);</span><br><span class="line">	_parameter_handles.climbout_diff = param_find(<span class="string">"FW_CLMBOUT_DIFF"</span>);</span><br><span class="line">	_parameter_handles.throttle_damp = param_find(<span class="string">"FW_T_THR_DAMP"</span>);</span><br><span class="line">	_parameter_handles.integrator_gain = param_find(<span class="string">"FW_T_INTEG_GAIN"</span>);</span><br><span class="line">	_parameter_handles.vertical_accel_limit = param_find(<span class="string">"FW_T_VERT_ACC"</span>);</span><br><span class="line">	_parameter_handles.height_comp_filter_omega = param_find(<span class="string">"FW_T_HGT_OMEGA"</span>);</span><br><span class="line">	_parameter_handles.speed_comp_filter_omega = param_find(<span class="string">"FW_T_SPD_OMEGA"</span>);</span><br><span class="line">	_parameter_handles.roll_throttle_compensation = param_find(<span class="string">"FW_T_RLL2THR"</span>);</span><br><span class="line">	_parameter_handles.speed_weight = param_find(<span class="string">"FW_T_SPDWEIGHT"</span>);</span><br><span class="line">	_parameter_handles.pitch_damping = param_find(<span class="string">"FW_T_PTCH_DAMP"</span>);</span><br><span class="line">	_parameter_handles.heightrate_p = param_find(<span class="string">"FW_T_HRATE_P"</span>);</span><br><span class="line">	_parameter_handles.heightrate_ff = param_find(<span class="string">"FW_T_HRATE_FF"</span>);</span><br><span class="line">	_parameter_handles.speedrate_p = param_find(<span class="string">"FW_T_SRATE_P"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if vehicle is vtol these handles will be set when we get the vehicle status</span></span><br><span class="line">	_parameter_handles.airspeed_trans = PARAM_INVALID;</span><br><span class="line">	_parameter_handles.vtol_type = PARAM_INVALID;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize to invalid vtol type</span></span><br><span class="line">	_parameters.vtol_type = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* fetch initial parameter values */</span></span><br><span class="line">	parameters_update();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FixedwingPositionControl::~FixedwingPositionControl()</span><br><span class="line">&#123;</span><br><span class="line">	perf_free(_loop_perf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新了飞行参数</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">FixedwingPositionControl::parameters_update()</span><br><span class="line">&#123;</span><br><span class="line">	updateParams();</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.airspeed_min, &amp;(_parameters.airspeed_min));</span><br><span class="line">	param_get(_parameter_handles.airspeed_trim, &amp;(_parameters.airspeed_trim));</span><br><span class="line">	param_get(_parameter_handles.airspeed_max, &amp;(_parameters.airspeed_max));</span><br><span class="line">	param_get(_parameter_handles.airspeed_disabled, &amp;(_parameters.airspeed_disabled));</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.pitch_limit_min, &amp;(_parameters.pitch_limit_min));</span><br><span class="line">	param_get(_parameter_handles.pitch_limit_max, &amp;(_parameters.pitch_limit_max));</span><br><span class="line">	param_get(_parameter_handles.throttle_min, &amp;(_parameters.throttle_min));</span><br><span class="line">	param_get(_parameter_handles.throttle_max, &amp;(_parameters.throttle_max));</span><br><span class="line">	param_get(_parameter_handles.throttle_idle, &amp;(_parameters.throttle_idle));</span><br><span class="line">	param_get(_parameter_handles.throttle_cruise, &amp;(_parameters.throttle_cruise));</span><br><span class="line">	param_get(_parameter_handles.throttle_alt_scale, &amp;(_parameters.throttle_alt_scale));</span><br><span class="line">	param_get(_parameter_handles.throttle_land_max, &amp;(_parameters.throttle_land_max));</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.man_roll_max_deg, &amp;_parameters.man_roll_max_rad);</span><br><span class="line">	_parameters.man_roll_max_rad = radians(_parameters.man_roll_max_rad);</span><br><span class="line">	param_get(_parameter_handles.man_pitch_max_deg, &amp;_parameters.man_pitch_max_rad);</span><br><span class="line">	_parameters.man_pitch_max_rad = radians(_parameters.man_pitch_max_rad);</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.rollsp_offset_deg, &amp;_parameters.rollsp_offset_rad);</span><br><span class="line">	_parameters.rollsp_offset_rad = radians(_parameters.rollsp_offset_rad);</span><br><span class="line">	param_get(_parameter_handles.pitchsp_offset_deg, &amp;_parameters.pitchsp_offset_rad);</span><br><span class="line">	_parameters.pitchsp_offset_rad = radians(_parameters.pitchsp_offset_rad);</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.climbout_diff, &amp;(_parameters.climbout_diff));</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.land_heading_hold_horizontal_distance,</span><br><span class="line">		  &amp;(_parameters.land_heading_hold_horizontal_distance));</span><br><span class="line">	param_get(_parameter_handles.land_flare_pitch_min_deg, &amp;(_parameters.land_flare_pitch_min_deg));</span><br><span class="line">	param_get(_parameter_handles.land_flare_pitch_max_deg, &amp;(_parameters.land_flare_pitch_max_deg));</span><br><span class="line">	param_get(_parameter_handles.land_use_terrain_estimate, &amp;(_parameters.land_use_terrain_estimate));</span><br><span class="line">	param_get(_parameter_handles.land_early_config_change, &amp;(_parameters.land_early_config_change));</span><br><span class="line">	param_get(_parameter_handles.land_airspeed_scale, &amp;(_parameters.land_airspeed_scale));</span><br><span class="line">	param_get(_parameter_handles.land_throtTC_scale, &amp;(_parameters.land_throtTC_scale));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// VTOL parameter VTOL_TYPE</span></span><br><span class="line">	<span class="keyword">if</span> (_parameter_handles.vtol_type != PARAM_INVALID) &#123;</span><br><span class="line">		param_get(_parameter_handles.vtol_type, &amp;_parameters.vtol_type);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// VTOL parameter VT_ARSP_TRANS</span></span><br><span class="line">	<span class="keyword">if</span> (_parameter_handles.airspeed_trans != PARAM_INVALID) &#123;</span><br><span class="line">		param_get(_parameter_handles.airspeed_trans, &amp;_parameters.airspeed_trans);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> v = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// L1 control parameters</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.l1_damping, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_l1_control.set_l1_damping(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.l1_period, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_l1_control.set_l1_period(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.roll_limit, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_l1_control.set_l1_roll_limit(radians(v));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.roll_slew_deg_sec, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_l1_control.set_roll_slew_rate(radians(v));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TECS parameters</span></span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.max_climb_rate, &amp;(_parameters.max_climb_rate));</span><br><span class="line">	_tecs.set_max_climb_rate(_parameters.max_climb_rate);</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.max_sink_rate, &amp;(_parameters.max_sink_rate));</span><br><span class="line">	_tecs.set_max_sink_rate(_parameters.max_sink_rate);</span><br><span class="line"></span><br><span class="line">	param_get(_parameter_handles.speed_weight, &amp;(_parameters.speed_weight));</span><br><span class="line">	_tecs.set_speed_weight(_parameters.speed_weight);</span><br><span class="line"></span><br><span class="line">	_tecs.set_indicated_airspeed_min(_parameters.airspeed_min);</span><br><span class="line">	_tecs.set_indicated_airspeed_max(_parameters.airspeed_max);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.time_const_throt, &amp;(_parameters.time_const_throt)) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_time_const_throt(_parameters.time_const_throt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.time_const, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_time_const(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.min_sink_rate, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_min_sink_rate(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.throttle_damp, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_throttle_damp(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.integrator_gain, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_integrator_gain(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.throttle_slew_max, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_throttle_slewrate(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.vertical_accel_limit, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_vertical_accel_limit(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.height_comp_filter_omega, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_height_comp_filter_omega(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.speed_comp_filter_omega, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_speed_comp_filter_omega(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.roll_throttle_compensation, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_roll_throttle_compensation(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.pitch_damping, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_pitch_damping(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.heightrate_p, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_heightrate_p(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.heightrate_ff, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_heightrate_ff(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (param_get(_parameter_handles.speedrate_p, &amp;v) == PX4_OK) &#123;</span><br><span class="line">		_tecs.set_speedrate_p(v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Landing slope</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> land_slope_angle = <span class="number">0.0f</span>;</span><br><span class="line">	param_get(_parameter_handles.land_slope_angle, &amp;land_slope_angle);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> land_flare_alt_relative = <span class="number">0.0f</span>;</span><br><span class="line">	param_get(_parameter_handles.land_flare_alt_relative, &amp;land_flare_alt_relative);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> land_thrust_lim_alt_relative = <span class="number">0.0f</span>;</span><br><span class="line">	param_get(_parameter_handles.land_thrust_lim_alt_relative, &amp;land_thrust_lim_alt_relative);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> land_H1_virt = <span class="number">0.0f</span>;</span><br><span class="line">	param_get(_parameter_handles.land_H1_virt, &amp;land_H1_virt);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* check if negative value for 2/3 of flare altitude is set for throttle cut */</span></span><br><span class="line">	<span class="keyword">if</span> (land_thrust_lim_alt_relative &lt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">		land_thrust_lim_alt_relative = <span class="number">0.66f</span> * land_flare_alt_relative;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_landingslope.update(radians(land_slope_angle), land_flare_alt_relative, land_thrust_lim_alt_relative, land_H1_virt);</span><br><span class="line"></span><br><span class="line">	landing_status_publish();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// sanity check parameters</span></span><br><span class="line">	<span class="keyword">if</span> ((_parameters.airspeed_max &lt; _parameters.airspeed_min) ||</span><br><span class="line">	    (_parameters.airspeed_max &lt; <span class="number">5.0f</span>) ||</span><br><span class="line">	    (_parameters.airspeed_min &gt; <span class="number">100.0f</span>) ||</span><br><span class="line">	    (_parameters.airspeed_trim &lt; _parameters.airspeed_min) ||</span><br><span class="line">	    (_parameters.airspeed_trim &gt; _parameters.airspeed_max)) &#123;</span><br><span class="line"></span><br><span class="line">		mavlink_log_critical(&amp;_mavlink_log_pub, <span class="string">"Airspeed parameters invalid"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> PX4_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> PX4_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//凡是_poll的函数，都是更新订阅的作用。</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::vehicle_control_mode_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> updated = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	orb_check(_control_mode_sub, &amp;updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (updated) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> was_armed = _control_mode.flag_armed;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (orb_copy(ORB_ID(vehicle_control_mode), _control_mode_sub, &amp;_control_mode) == PX4_OK) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// reset state when arming</span></span><br><span class="line">			<span class="keyword">if</span> (!was_armed &amp;&amp; _control_mode.flag_armed) &#123;</span><br><span class="line">				reset_takeoff_state(<span class="literal">true</span>);</span><br><span class="line">				reset_landing_state();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::vehicle_command_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> updated;</span><br><span class="line"></span><br><span class="line">	orb_check(_vehicle_command_sub, &amp;updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (updated) &#123;</span><br><span class="line">		orb_copy(ORB_ID(vehicle_command), _vehicle_command_sub, &amp;_vehicle_command);</span><br><span class="line">		handle_command();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::vehicle_status_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> updated;</span><br><span class="line"></span><br><span class="line">	orb_check(_vehicle_status_sub, &amp;updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (updated) &#123;</span><br><span class="line">		orb_copy(ORB_ID(vehicle_status), _vehicle_status_sub, &amp;_vehicle_status);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* set correct uORB ID, depending on if vehicle is VTOL or not */</span></span><br><span class="line">		<span class="keyword">if</span> (_attitude_setpoint_id == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (_vehicle_status.is_vtol) &#123;</span><br><span class="line">				_attitude_setpoint_id = ORB_ID(fw_virtual_attitude_setpoint);</span><br><span class="line"></span><br><span class="line">				_parameter_handles.airspeed_trans = param_find(<span class="string">"VT_ARSP_TRANS"</span>);</span><br><span class="line">				_parameter_handles.vtol_type = param_find(<span class="string">"VT_TYPE"</span>);</span><br><span class="line"></span><br><span class="line">				parameters_update();</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				_attitude_setpoint_id = ORB_ID(vehicle_attitude_setpoint);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::vehicle_land_detected_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> updated;</span><br><span class="line"></span><br><span class="line">	orb_check(_vehicle_land_detected_sub, &amp;updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (updated) &#123;</span><br><span class="line">		orb_copy(ORB_ID(vehicle_land_detected), _vehicle_land_detected_sub, &amp;_vehicle_land_detected);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::manual_control_setpoint_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> manual_updated;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Check if manual setpoint has changed */</span></span><br><span class="line">	orb_check(_manual_control_sub, &amp;manual_updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (manual_updated) &#123;</span><br><span class="line">		orb_copy(ORB_ID(manual_control_setpoint), _manual_control_sub, &amp;_manual);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::airspeed_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">bool</span> airspeed_valid = _airspeed_valid;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!_parameters.airspeed_disabled &amp;&amp; _sub_airspeed.update()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> airspeed_s &amp;as = _sub_airspeed.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (PX4_ISFINITE(as.indicated_airspeed_m_s)</span><br><span class="line">		    &amp;&amp; PX4_ISFINITE(as.true_airspeed_m_s)</span><br><span class="line">		    &amp;&amp; (as.indicated_airspeed_m_s &gt; <span class="number">0.0f</span>)</span><br><span class="line">		    &amp;&amp; !_vehicle_status.aspd_use_inhibit) &#123;</span><br><span class="line"></span><br><span class="line">			airspeed_valid = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			_airspeed_last_valid = as.timestamp;</span><br><span class="line">			_airspeed = as.indicated_airspeed_m_s;</span><br><span class="line"></span><br><span class="line">			_eas2tas = <span class="built_in">constrain</span>(as.true_airspeed_m_s / as.indicated_airspeed_m_s, <span class="number">0.9f</span>, <span class="number">2.0f</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// no airspeed updates for one second</span></span><br><span class="line">		<span class="keyword">if</span> (airspeed_valid &amp;&amp; (hrt_elapsed_time(&amp;_airspeed_last_valid) &gt; <span class="number">1</span>_s)) &#123;</span><br><span class="line">			airspeed_valid = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// update TECS if validity changed</span></span><br><span class="line">	<span class="keyword">if</span> (airspeed_valid != _airspeed_valid) &#123;</span><br><span class="line">		_tecs.enable_airspeed(airspeed_valid);</span><br><span class="line">		_airspeed_valid = airspeed_valid;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::vehicle_attitude_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* check if there is a new position */</span></span><br><span class="line">	<span class="keyword">bool</span> updated;</span><br><span class="line">	orb_check(_vehicle_attitude_sub, &amp;updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (updated) &#123;</span><br><span class="line">		orb_copy(ORB_ID(vehicle_attitude), _vehicle_attitude_sub, &amp;_att);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set rotation matrix and euler angles */</span></span><br><span class="line">	_R_nb = Quatf(_att.q);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if the vehicle is a tailsitter we have to rotate the attitude by the pitch offset</span></span><br><span class="line">	<span class="comment">// between multirotor and fixed wing flight</span></span><br><span class="line">	<span class="keyword">if</span> (_parameters.vtol_type == vtol_type::TAILSITTER &amp;&amp; _vehicle_status.is_vtol) &#123;</span><br><span class="line">		Dcmf R_offset = Eulerf(<span class="number">0</span>, M_PI_2_F, <span class="number">0</span>);</span><br><span class="line">		_R_nb = _R_nb * R_offset;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Eulerf <span class="title">euler_angles</span><span class="params">(_R_nb)</span></span>;</span><br><span class="line">	_roll    = euler_angles(<span class="number">0</span>);</span><br><span class="line">	_pitch   = euler_angles(<span class="number">1</span>);</span><br><span class="line">	_yaw     = euler_angles(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::position_setpoint_triplet_poll()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* check if there is a new setpoint */</span></span><br><span class="line">	<span class="keyword">bool</span> pos_sp_triplet_updated;</span><br><span class="line">	orb_check(_pos_sp_triplet_sub, &amp;pos_sp_triplet_updated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos_sp_triplet_updated) &#123;</span><br><span class="line">		orb_copy(ORB_ID(position_setpoint_triplet), _pos_sp_triplet_sub, &amp;_pos_sp_triplet);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用在手工控制中，根据遥控器的油门得到设定的空速。</span></span><br><span class="line"><span class="keyword">float</span></span><br><span class="line">FixedwingPositionControl::get_demanded_airspeed()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> altctrl_airspeed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// neutral throttle corresponds to trim airspeed</span></span><br><span class="line">	<span class="keyword">if</span> (_manual.z &lt; <span class="number">0.5f</span>) &#123;</span><br><span class="line">		<span class="comment">// lower half of throttle is min to trim airspeed</span></span><br><span class="line">		altctrl_airspeed = _parameters.airspeed_min +</span><br><span class="line">				   (_parameters.airspeed_trim - _parameters.airspeed_min) *</span><br><span class="line">				   _manual.z * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// upper half of throttle is trim to max airspeed</span></span><br><span class="line">		altctrl_airspeed = _parameters.airspeed_trim +</span><br><span class="line">				   (_parameters.airspeed_max - _parameters.airspeed_trim) *</span><br><span class="line">				   (_manual.z * <span class="number">2</span> - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> altctrl_airspeed;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//基于下面gndspeed_undershoot的讨论，得到我们到底想要多大的空速airspeed。</span></span><br><span class="line"><span class="comment">//下面的函数，综合考虑了gndspeed_undershoot和失速速度的限制。</span></span><br><span class="line"><span class="comment">//最后返回一个以不失速为前提的满足airspeed_demand += _groundspeed_undershoot的空速期望值</span></span><br><span class="line"><span class="keyword">float</span></span><br><span class="line">FixedwingPositionControl::calculate_target_airspeed(<span class="keyword">float</span> airspeed_demand)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Calculate accelerated stall airspeed factor from commanded bank angle and use it to increase minimum airspeed.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *  We don't know the stall speed of the aircraft, but assuming user defined</span></span><br><span class="line"><span class="comment">	 *  minimum airspeed (FW_AIRSPD_MIN) is slightly larger than stall speed</span></span><br><span class="line"><span class="comment">	 *  this is close enough.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * increase lift vector to balance additional weight in bank</span></span><br><span class="line"><span class="comment">	 *  cos(bank angle) = W/L = 1/n</span></span><br><span class="line"><span class="comment">	 *   n is the load factor</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * lift is proportional to airspeed^2 so the increase in stall speed is</span></span><br><span class="line"><span class="comment">	 *  Vsacc = Vs * sqrt(n)</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">float</span> adjusted_min_airspeed = _parameters.airspeed_min;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_airspeed_valid &amp;&amp; PX4_ISFINITE(_att_sp.roll_body)) &#123;</span><br><span class="line"></span><br><span class="line">		adjusted_min_airspeed = <span class="built_in">constrain</span>(_parameters.airspeed_min / sqrtf(cosf(_att_sp.roll_body)), _parameters.airspeed_min,</span><br><span class="line">						  _parameters.airspeed_max);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// add minimum ground speed undershoot (only non-zero in presence of sufficient wind)</span></span><br><span class="line">	<span class="comment">// sanity check: limit to range</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">constrain</span>(airspeed_demand + _groundspeed_undershoot, adjusted_min_airspeed, _parameters.airspeed_max);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类似于空速与最小地速的差值</span></span><br><span class="line"><span class="comment">//如果顺风，那么空速等于飞机速度加风速，否则逆风就是飞机速度减风速。</span></span><br><span class="line"><span class="comment">//当空速大于最小地速时，gndspeed_undershoot等于0,说明当前情况很OK</span></span><br><span class="line"><span class="comment">//当空速小于最小地速时，gndspeed_undershoot为二者差值（&gt;0）,说明需要增大飞机速度。</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::calculate_gndspeed_undershoot(<span class="keyword">const</span> Vector2f &amp;curr_pos,</span><br><span class="line">		<span class="keyword">const</span> Vector2f &amp;ground_speed,</span><br><span class="line">		<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (pos_sp_curr.valid &amp;&amp; !_l1_control.circle_mode()) &#123;</span><br><span class="line">		<span class="comment">/* rotate ground speed vector with current attitude */</span></span><br><span class="line">		<span class="function">Vector2f <span class="title">yaw_vector</span><span class="params">(_R_nb(<span class="number">0</span>, <span class="number">0</span>), _R_nb(<span class="number">1</span>, <span class="number">0</span>))</span></span>;</span><br><span class="line">		yaw_vector.normalize();</span><br><span class="line">		<span class="keyword">float</span> ground_speed_body = yaw_vector * ground_speed;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* The minimum desired ground speed is the minimum airspeed projected on to the ground using the altitude and horizontal difference between the waypoints if available*/</span></span><br><span class="line">		<span class="keyword">float</span> distance = <span class="number">0.0f</span>;</span><br><span class="line">		<span class="keyword">float</span> delta_altitude = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">			distance = get_distance_to_next_waypoint(pos_sp_prev.lat, pos_sp_prev.lon, pos_sp_curr.lat, pos_sp_curr.lon);</span><br><span class="line">			delta_altitude = pos_sp_curr.alt - pos_sp_prev.alt;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			distance = get_distance_to_next_waypoint((<span class="keyword">double</span>)curr_pos(<span class="number">0</span>), (<span class="keyword">double</span>)curr_pos(<span class="number">1</span>), pos_sp_curr.lat, pos_sp_curr.lon);</span><br><span class="line">			delta_altitude = pos_sp_curr.alt - _global_pos.alt;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> ground_speed_desired = _parameters.airspeed_min * cosf(atan2f(delta_altitude, distance));</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Ground speed undershoot is the amount of ground velocity not reached</span></span><br><span class="line"><span class="comment">		 * by the plane. Consequently it is zero if airspeed is &gt;= min ground speed</span></span><br><span class="line"><span class="comment">		 * and positive if airspeed &lt; min ground speed.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * This error value ensures that a plane (as long as its throttle capability is</span></span><br><span class="line"><span class="comment">		 * not exceeded) travels towards a waypoint (and is not pushed more and more away</span></span><br><span class="line"><span class="comment">		 * by wind). Not countering this would lead to a fly-away.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		_groundspeed_undershoot = <span class="built_in">max</span>(ground_speed_desired - ground_speed_body, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_groundspeed_undershoot = <span class="number">0.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//带_publish的都是发布uORB消息的函数，和飞控无关，没啥好说的</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::tecs_status_publish()</span><br><span class="line">&#123;</span><br><span class="line">	tecs_status_s t = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (_tecs.tecs_mode()) &#123;</span><br><span class="line">	<span class="keyword">case</span> TECS::ECL_TECS_MODE_NORMAL:</span><br><span class="line">		t.mode = tecs_status_s::TECS_MODE_NORMAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> TECS::ECL_TECS_MODE_UNDERSPEED:</span><br><span class="line">		t.mode = tecs_status_s::TECS_MODE_UNDERSPEED;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> TECS::ECL_TECS_MODE_BAD_DESCENT:</span><br><span class="line">		t.mode = tecs_status_s::TECS_MODE_BAD_DESCENT;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> TECS::ECL_TECS_MODE_CLIMBOUT:</span><br><span class="line">		t.mode = tecs_status_s::TECS_MODE_CLIMBOUT;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	t.altitude_sp = _tecs.hgt_setpoint_adj();</span><br><span class="line">	t.altitude_filtered = _tecs.vert_pos_state();</span><br><span class="line"></span><br><span class="line">	t.airspeed_sp = _tecs.TAS_setpoint_adj();</span><br><span class="line">	t.airspeed_filtered = _tecs.tas_state();</span><br><span class="line"></span><br><span class="line">	t.height_rate_setpoint = _tecs.hgt_rate_setpoint();</span><br><span class="line">	t.height_rate = _tecs.vert_vel_state();</span><br><span class="line"></span><br><span class="line">	t.airspeed_derivative_sp = _tecs.TAS_rate_setpoint();</span><br><span class="line">	t.airspeed_derivative = _tecs.speed_derivative();</span><br><span class="line"></span><br><span class="line">	t.total_energy_error = _tecs.STE_error();</span><br><span class="line">	t.total_energy_rate_error = _tecs.STE_rate_error();</span><br><span class="line"></span><br><span class="line">	t.energy_distribution_error = _tecs.SEB_error();</span><br><span class="line">	t.energy_distribution_rate_error = _tecs.SEB_rate_error();</span><br><span class="line"></span><br><span class="line">	t.throttle_integ = _tecs.throttle_integ_state();</span><br><span class="line">	t.pitch_integ = _tecs.pitch_integ_state();</span><br><span class="line"></span><br><span class="line">	t.timestamp = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_tecs_status_pub != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		orb_publish(ORB_ID(tecs_status), _tecs_status_pub, &amp;t);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_tecs_status_pub = orb_advertise(ORB_ID(tecs_status), &amp;t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::status_publish()</span><br><span class="line">&#123;</span><br><span class="line">	position_controller_status_s pos_ctrl_status = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	pos_ctrl_status.nav_roll = _att_sp.roll_body;</span><br><span class="line">	pos_ctrl_status.nav_pitch = _att_sp.pitch_body;</span><br><span class="line">	pos_ctrl_status.nav_bearing = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">	pos_ctrl_status.target_bearing = _l1_control.target_bearing();</span><br><span class="line">	pos_ctrl_status.xtrack_error = _l1_control.crosstrack_error();</span><br><span class="line"></span><br><span class="line">	pos_ctrl_status.wp_dist = get_distance_to_next_waypoint(_global_pos.lat, _global_pos.lon,</span><br><span class="line">				  _pos_sp_triplet.current.lat, _pos_sp_triplet.current.lon);</span><br><span class="line"></span><br><span class="line">	pos_ctrl_status.acceptance_radius = _l1_control.switch_distance(<span class="number">500.0f</span>);</span><br><span class="line"></span><br><span class="line">	pos_ctrl_status.yaw_acceptance = NAN;</span><br><span class="line"></span><br><span class="line">	pos_ctrl_status.timestamp = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_pos_ctrl_status_pub != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		orb_publish(ORB_ID(position_controller_status), _pos_ctrl_status_pub, &amp;pos_ctrl_status);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_pos_ctrl_status_pub = orb_advertise(ORB_ID(position_controller_status), &amp;pos_ctrl_status);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::landing_status_publish()</span><br><span class="line">&#123;</span><br><span class="line">	position_controller_landing_status_s pos_ctrl_landing_status = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	pos_ctrl_landing_status.slope_angle_rad = _landingslope.landing_slope_angle_rad();</span><br><span class="line">	pos_ctrl_landing_status.horizontal_slope_displacement = _landingslope.horizontal_slope_displacement();</span><br><span class="line">	pos_ctrl_landing_status.flare_length = _landingslope.flare_length();</span><br><span class="line"></span><br><span class="line">	pos_ctrl_landing_status.abort_landing = _land_abort;</span><br><span class="line"></span><br><span class="line">	pos_ctrl_landing_status.timestamp = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_pos_ctrl_landing_status_pub != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		orb_publish(ORB_ID(position_controller_landing_status), _pos_ctrl_landing_status_pub, &amp;pos_ctrl_landing_status);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_pos_ctrl_landing_status_pub = orb_advertise(ORB_ID(position_controller_landing_status), &amp;pos_ctrl_landing_status);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::abort_landing(<span class="keyword">bool</span> <span class="built_in">abort</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// only announce changes</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">abort</span> &amp;&amp; !_land_abort) &#123;</span><br><span class="line">		mavlink_log_critical(&amp;_mavlink_log_pub, <span class="string">"Landing aborted"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_land_abort = <span class="built_in">abort</span>;</span><br><span class="line">	landing_status_publish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::get_waypoint_heading_distance(<span class="keyword">float</span> heading, position_setpoint_s &amp;waypoint_prev,</span><br><span class="line">		position_setpoint_s &amp;waypoint_next, <span class="keyword">bool</span> flag_init)</span><br><span class="line">&#123;</span><br><span class="line">	position_setpoint_s temp_prev = waypoint_prev;</span><br><span class="line">	position_setpoint_s temp_next = waypoint_next;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flag_init) &#123;</span><br><span class="line">		<span class="comment">// previous waypoint: HDG_HOLD_SET_BACK_DIST meters behind us</span></span><br><span class="line">		waypoint_from_heading_and_distance(_global_pos.lat, _global_pos.lon, heading + radians(<span class="number">180.0f</span>),</span><br><span class="line">						   HDG_HOLD_SET_BACK_DIST, &amp;temp_prev.lat, &amp;temp_prev.lon);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// next waypoint: HDG_HOLD_DIST_NEXT meters in front of us</span></span><br><span class="line">		waypoint_from_heading_and_distance(_global_pos.lat, _global_pos.lon, heading,</span><br><span class="line">						   HDG_HOLD_DIST_NEXT, &amp;temp_next.lat, &amp;temp_next.lon);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// use the existing flight path from prev to next</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// previous waypoint: shifted HDG_HOLD_REACHED_DIST + HDG_HOLD_SET_BACK_DIST</span></span><br><span class="line">		create_waypoint_from_line_and_dist(waypoint_next.lat, waypoint_next.lon, waypoint_prev.lat, waypoint_prev.lon,</span><br><span class="line">						   HDG_HOLD_REACHED_DIST + HDG_HOLD_SET_BACK_DIST, &amp;temp_prev.lat, &amp;temp_prev.lon);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// next waypoint: shifted -(HDG_HOLD_DIST_NEXT + HDG_HOLD_REACHED_DIST)</span></span><br><span class="line">		create_waypoint_from_line_and_dist(waypoint_next.lat, waypoint_next.lon, waypoint_prev.lat, waypoint_prev.lon,</span><br><span class="line">						   -(HDG_HOLD_REACHED_DIST + HDG_HOLD_DIST_NEXT), &amp;temp_next.lat, &amp;temp_next.lon);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	waypoint_prev = temp_prev;</span><br><span class="line">	waypoint_prev.alt = _hold_alt;</span><br><span class="line">	waypoint_prev.valid = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	waypoint_next = temp_next;</span><br><span class="line">	waypoint_next.alt = _hold_alt;</span><br><span class="line">	waypoint_next.valid = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span></span><br><span class="line">FixedwingPositionControl::get_terrain_altitude_takeoff(<span class="keyword">float</span> takeoff_alt,</span><br><span class="line">		<span class="keyword">const</span> vehicle_global_position_s &amp;global_pos)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (PX4_ISFINITE(global_pos.terrain_alt) &amp;&amp; global_pos.terrain_alt_valid) &#123;</span><br><span class="line">		<span class="keyword">return</span> global_pos.terrain_alt;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> takeoff_alt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span></span><br><span class="line">FixedwingPositionControl::update_desired_altitude(<span class="keyword">float</span> dt)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The complete range is -1..+1, so this is 6%</span></span><br><span class="line"><span class="comment">	 * of the up or down range or 3% of the total range.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> deadBand = <span class="number">0.06f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The correct scaling of the complete range needs</span></span><br><span class="line"><span class="comment">	 * to account for the missing part of the slope</span></span><br><span class="line"><span class="comment">	 * due to the deadband</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> factor = <span class="number">1.0f</span> - deadBand;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Climbout mode sets maximum throttle and pitch up */</span></span><br><span class="line">	<span class="keyword">bool</span> climbout_mode = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reset the hold altitude to the current altitude if the uncertainty</span></span><br><span class="line"><span class="comment">	 * changes significantly.</span></span><br><span class="line"><span class="comment">	 * This is to guard against uncommanded altitude changes</span></span><br><span class="line"><span class="comment">	 * when the altitude certainty increases or decreases.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fabsf(_althold_epv - _global_pos.epv) &gt; ALTHOLD_EPV_RESET_THRESH) &#123;</span><br><span class="line">		_hold_alt = _global_pos.alt;</span><br><span class="line">		_althold_epv = _global_pos.epv;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Manual control has as convention the rotation around</span></span><br><span class="line"><span class="comment">	 * an axis. Positive X means to rotate positively around</span></span><br><span class="line"><span class="comment">	 * the X axis in NED frame, which is pitching down</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (_manual.x &gt; deadBand) &#123;</span><br><span class="line">		<span class="comment">/* pitching down */</span></span><br><span class="line">		<span class="keyword">float</span> pitch = -(_manual.x - deadBand) / factor;</span><br><span class="line">		_hold_alt += (_parameters.max_sink_rate * dt) * pitch;</span><br><span class="line">		_was_in_deadband = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_manual.x &lt; - deadBand) &#123;</span><br><span class="line">		<span class="comment">/* pitching up */</span></span><br><span class="line">		<span class="keyword">float</span> pitch = -(_manual.x + deadBand) / factor;</span><br><span class="line">		_hold_alt += (_parameters.max_climb_rate * dt) * pitch;</span><br><span class="line">		_was_in_deadband = <span class="literal">false</span>;</span><br><span class="line">		climbout_mode = (pitch &gt; MANUAL_THROTTLE_CLIMBOUT_THRESH);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!_was_in_deadband) &#123;</span><br><span class="line">		<span class="comment">/* store altitude at which manual.x was inside deadBand</span></span><br><span class="line"><span class="comment">		 * The aircraft should immediately try to fly at this altitude</span></span><br><span class="line"><span class="comment">		 * as this is what the pilot expects when he moves the stick to the center */</span></span><br><span class="line">		_hold_alt = _global_pos.alt;</span><br><span class="line">		_althold_epv = _global_pos.epv;</span><br><span class="line">		_was_in_deadband = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_status.is_vtol) &#123;</span><br><span class="line">		<span class="keyword">if</span> (_vehicle_status.is_rotary_wing || _vehicle_status.in_transition_mode) &#123;</span><br><span class="line">			_hold_alt = _global_pos.alt;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> climbout_mode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span></span><br><span class="line">FixedwingPositionControl::in_takeoff_situation()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// a VTOL does not need special takeoff handling</span></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_status.is_vtol) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// in air for &lt; 10s</span></span><br><span class="line">	<span class="keyword">const</span> hrt_abstime delta_takeoff = <span class="number">10</span>_s;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (hrt_elapsed_time(&amp;_time_went_in_air) &lt; delta_takeoff)</span><br><span class="line">	       &amp;&amp; (_global_pos.alt &lt;= _takeoff_ground_alt + _parameters.climbout_diff);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::do_takeoff_help(<span class="keyword">float</span> *hold_altitude, <span class="keyword">float</span> *pitch_limit_min)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* demand "climbout_diff" m above ground if user switched into this mode during takeoff */</span></span><br><span class="line">	<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">		*hold_altitude = _takeoff_ground_alt + _parameters.climbout_diff;</span><br><span class="line">		*pitch_limit_min = radians(<span class="number">10.0f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在run中调用，无论是什么模式，必定运行。只要顺利更新了姿态和油门，就返回True</span></span><br><span class="line"><span class="keyword">bool</span></span><br><span class="line">FixedwingPositionControl::control_position(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed,</span><br><span class="line">		<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> dt = <span class="number">0.01f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_control_position_last_called &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		dt = hrt_elapsed_time(&amp;_control_position_last_called) * <span class="number">1e-6</span>f;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_control_position_last_called = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">	_l1_control.set_dt(dt);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* only run position controller in fixed-wing mode and during transitions for VTOL */</span></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_status.is_rotary_wing &amp;&amp; !_vehicle_status.in_transition_mode) &#123;</span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_OTHER;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> setpoint = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	_att_sp.fw_control_yaw = <span class="literal">false</span>;		<span class="comment">// by default we don't want yaw to be contoller directly with rudder</span></span><br><span class="line">	_att_sp.apply_flaps = vehicle_attitude_setpoint_s::FLAPS_OFF;		<span class="comment">// by default we don't use flaps</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新_gndspeed_undershoot,关于这个参数的概念见该函数前的注释</span></span><br><span class="line">	calculate_gndspeed_undershoot(curr_pos, ground_speed, pos_sp_prev, pos_sp_curr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个巡航速度，初始值为地速</span></span><br><span class="line">	Vector2f nav_speed_2d&#123;ground_speed&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_airspeed_valid) &#123;</span><br><span class="line">		<span class="comment">// l1 navigation logic breaks down when wind speed exceeds max airspeed</span></span><br><span class="line">		<span class="comment">// compute 2D groundspeed from airspeed-heading projection</span></span><br><span class="line">        <span class="comment">//将垂直平面内空速进行分解</span></span><br><span class="line">		const Vector2f air_speed_2d&#123;_airspeed * cosf(_yaw), _airspeed * sinf(_yaw)&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// angle between air_speed_2d and ground_speed</span></span><br><span class="line">        <span class="comment">// 得到空速和地速之间的夹角</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> air_gnd_angle = acosf((air_speed_2d * ground_speed) / (air_speed_2d.length() * ground_speed.length()));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if angle &gt; 90 degrees or groundspeed is less than threshold, replace groundspeed with airspeed projection</span></span><br><span class="line">		<span class="keyword">if</span> ((fabsf(air_gnd_angle) &gt; M_PI_2_F) || (ground_speed.length() &lt; <span class="number">3.0f</span>)) &#123;</span><br><span class="line">			nav_speed_2d = air_speed_2d;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* no throttle limit as default */</span></span><br><span class="line">	<span class="keyword">float</span> throttle_max = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* save time when airplane is in air */</span></span><br><span class="line">	<span class="keyword">if</span> (!_was_in_air &amp;&amp; !_vehicle_land_detected.landed) &#123;</span><br><span class="line">		_was_in_air = <span class="literal">true</span>;</span><br><span class="line">		_time_went_in_air = hrt_absolute_time();</span><br><span class="line">		_takeoff_ground_alt = _global_pos.alt;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* reset flag when airplane landed */</span></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_land_detected.landed) &#123;</span><br><span class="line">		_was_in_air = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Reset integrators if switching to this mode from a other mode in which posctl was not active */</span></span><br><span class="line">	<span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_OTHER) &#123;</span><br><span class="line">		<span class="comment">/* reset integrators */</span></span><br><span class="line">		_tecs.reset_state();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自动控制模式（从navigator接受sp）：</span></span><br><span class="line">	<span class="keyword">if</span> (_control_mode.flag_control_auto_enabled &amp;&amp; pos_sp_curr.valid) &#123;</span><br><span class="line">		<span class="comment">/* AUTONOMOUS FLIGHT */</span></span><br><span class="line"></span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_AUTO;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset hold altitude */</span></span><br><span class="line">		_hold_alt = _global_pos.alt;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset hold yaw */</span></span><br><span class="line">		_hdg_hold_yaw = _yaw;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* get circle mode */</span></span><br><span class="line">		<span class="keyword">bool</span> was_circle_mode = _l1_control.circle_mode();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* restore TECS parameters, in case changed intermittently (e.g. in landing handling) */</span></span><br><span class="line">		_tecs.set_speed_weight(_parameters.speed_weight);</span><br><span class="line">		_tecs.set_time_const_throt(_parameters.time_const_throt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* current waypoint (the one currently heading for) */</span></span><br><span class="line">		<span class="function">Vector2f <span class="title">curr_wp</span><span class="params">((<span class="keyword">float</span>)pos_sp_curr.lat, (<span class="keyword">float</span>)pos_sp_curr.lon)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Initialize attitude controller integrator reset flags to 0 */</span></span><br><span class="line">		_att_sp.roll_reset_integral = <span class="literal">false</span>;</span><br><span class="line">		_att_sp.pitch_reset_integral = <span class="literal">false</span>;</span><br><span class="line">		_att_sp.yaw_reset_integral = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* previous waypoint */</span></span><br><span class="line">		Vector2f prev_wp&#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">			prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_prev.lat;</span><br><span class="line">			prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_prev.lon;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * No valid previous waypoint, go for the current wp.</span></span><br><span class="line"><span class="comment">			 * This is automatically handled by the L1 library.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_curr.lat;</span><br><span class="line">			prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_curr.lon;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//以下生成速度和油门的sp，留待下文传输到TECS中。</span></span><br><span class="line">        <span class="comment">//默认期望以巡航速度飞行</span></span><br><span class="line">		<span class="keyword">float</span> mission_airspeed = _parameters.airspeed_trim;</span><br><span class="line">        <span class="comment">//如果当前sp有设定的速度，就覆盖原来的值</span></span><br><span class="line">		<span class="keyword">if</span> (PX4_ISFINITE(pos_sp_curr.cruising_speed) &amp;&amp;</span><br><span class="line">		    pos_sp_curr.cruising_speed &gt; <span class="number">0.1f</span>) &#123;</span><br><span class="line"></span><br><span class="line">			mission_airspeed = pos_sp_curr.cruising_speed;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//默认期望以巡航油门飞行</span></span><br><span class="line">		<span class="keyword">float</span> mission_throttle = _parameters.throttle_cruise;</span><br><span class="line">        <span class="comment">//如果当前sp有设定的油门，就覆盖原来的值</span></span><br><span class="line">		<span class="keyword">if</span> (PX4_ISFINITE(pos_sp_curr.cruising_throttle) &amp;&amp;</span><br><span class="line">		    pos_sp_curr.cruising_throttle &gt; <span class="number">0.01f</span>) &#123;</span><br><span class="line"></span><br><span class="line">			mission_throttle = pos_sp_curr.cruising_throttle;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//前面是只要是自动控制模式，所有子模式都运行的，下面是各个子任务的分支。</span></span><br><span class="line">        <span class="comment">//如果当前sp的模式是IDLE，那么三个输入（油门、滚转、俯仰）都是0</span></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_IDLE) &#123;</span><br><span class="line">			_att_sp.thrust_body[<span class="number">0</span>] = <span class="number">0.0f</span>;</span><br><span class="line">			_att_sp.roll_body = <span class="number">0.0f</span>;</span><br><span class="line">			_att_sp.pitch_body = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前sp的模式是POSITION，那么首先调用l1控制的获得下一个路径点，获得需要的滚转角。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_POSITION) &#123;</span><br><span class="line">			<span class="comment">/* waypoint is a plain navigation waypoint */</span></span><br><span class="line">			_l1_control.navigate_waypoints(prev_wp, curr_wp, curr_pos, nav_speed_2d);</span><br><span class="line">			_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">            _att_sp.yaw_body = _l1_control.nav_bearing();<span class="comment">//nav_bearing默认是0</span></span><br><span class="line">            <span class="comment">//更新TECS系统，设定相应的油门和俯仰</span></span><br><span class="line">			tecs_update_pitch_throttle(pos_sp_curr.alt,</span><br><span class="line">						   calculate_target_airspeed(mission_airspeed),</span><br><span class="line">						   radians(_parameters.pitch_limit_min) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   radians(_parameters.pitch_limit_max) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   _parameters.throttle_min,</span><br><span class="line">						   _parameters.throttle_max,</span><br><span class="line">						   mission_throttle,</span><br><span class="line">						   <span class="literal">false</span>,</span><br><span class="line">						   radians(_parameters.pitch_limit_min));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前sp的模式是悬停，那么也是首先调用l1控制的获得下一个路径点（调用的api和上面的不一样），获得需要的滚转角。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_LOITER) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* waypoint is a loiter waypoint */</span></span><br><span class="line">			_l1_control.navigate_loiter(curr_wp, curr_pos, pos_sp_curr.loiter_radius,</span><br><span class="line">						    pos_sp_curr.loiter_direction, nav_speed_2d);</span><br><span class="line">			_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">			_att_sp.yaw_body = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">float</span> alt_sp = pos_sp_curr.alt;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (pos_sp_next.type == position_setpoint_s::SETPOINT_TYPE_LAND &amp;&amp; pos_sp_next.valid</span><br><span class="line">			    &amp;&amp; _l1_control.circle_mode() &amp;&amp; _parameters.land_early_config_change == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="comment">// We're in a loiter directly before a landing WP. Enable our landing configuration (flaps,</span></span><br><span class="line">				<span class="comment">// landing airspeed and potentially tighter throttle control) already such that we don't</span></span><br><span class="line">				<span class="comment">// have to do this switch (which can cause significant altitude errors) close to the ground.</span></span><br><span class="line">				_tecs.set_time_const_throt(_parameters.land_throtTC_scale * _parameters.time_const_throt);</span><br><span class="line">				mission_airspeed = _parameters.land_airspeed_scale * _parameters.airspeed_min;</span><br><span class="line">				_att_sp.apply_flaps = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">				alt_sp = <span class="built_in">max</span>(alt_sp, _takeoff_ground_alt + _parameters.climbout_diff);</span><br><span class="line">				_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, radians(<span class="number">-5.0f</span>), radians(<span class="number">5.0f</span>));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_land_abort) &#123;</span><br><span class="line">				<span class="keyword">if</span> (pos_sp_curr.alt - _global_pos.alt  &lt; _parameters.climbout_diff) &#123;</span><br><span class="line">					<span class="comment">// aborted landing complete, normal loiter over landing point</span></span><br><span class="line">					abort_landing(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">// continue straight until vehicle has sufficient altitude</span></span><br><span class="line">					_att_sp.roll_body = <span class="number">0.0f</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				_tecs.set_time_const_throt(_parameters.land_throtTC_scale * _parameters.time_const_throt);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			tecs_update_pitch_throttle(alt_sp,</span><br><span class="line">						   calculate_target_airspeed(mission_airspeed),</span><br><span class="line">						   radians(_parameters.pitch_limit_min) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   radians(_parameters.pitch_limit_max) - _parameters.pitchsp_offset_rad,</span><br><span class="line">						   _parameters.throttle_min,</span><br><span class="line">						   _parameters.throttle_max,</span><br><span class="line">						   _parameters.throttle_cruise,</span><br><span class="line">						   <span class="literal">false</span>,</span><br><span class="line">						   radians(_parameters.pitch_limit_min));</span><br><span class="line">        <span class="comment">//如果当前sp的模式是降落，调用control_land函数。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_LAND) &#123;</span><br><span class="line">			control_landing(curr_pos, ground_speed, pos_sp_prev, pos_sp_curr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果当前sp的模式是降落，调用control_takeoff函数。</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF) &#123;</span><br><span class="line">			control_takeoff(curr_pos, ground_speed, pos_sp_prev, pos_sp_curr);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset landing state */</span></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_curr.type != position_setpoint_s::SETPOINT_TYPE_LAND) &#123;</span><br><span class="line">			reset_landing_state();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset takeoff/launch state */</span></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_curr.type != position_setpoint_s::SETPOINT_TYPE_TAKEOFF) &#123;</span><br><span class="line">			reset_takeoff_state();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (was_circle_mode &amp;&amp; !_l1_control.circle_mode()) &#123;</span><br><span class="line">			<span class="comment">/* just kicked out of loiter, reset roll integrals */</span></span><br><span class="line">			_att_sp.roll_reset_integral = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果不是自动控制模式，而是手工的定速度、定高度控制</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode.flag_control_velocity_enabled &amp;&amp;</span><br><span class="line">		   _control_mode.flag_control_altitude_enabled) &#123;</span><br><span class="line">		<span class="comment">/* POSITION CONTROL: pitch stick moves altitude setpoint, throttle stick sets airspeed,</span></span><br><span class="line"><span class="comment">		   heading is set to a distant waypoint */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_control_mode_current != FW_POSCTRL_MODE_POSITION) &#123;</span><br><span class="line">			<span class="comment">/* Need to init because last loop iteration was in a different mode */</span></span><br><span class="line">			_hold_alt = _global_pos.alt;</span><br><span class="line">			_hdg_hold_yaw = _yaw;</span><br><span class="line">			_hdg_hold_enabled = <span class="literal">false</span>; <span class="comment">// this makes sure the waypoints are reset below</span></span><br><span class="line">			_yaw_lock_engaged = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* reset setpoints from other modes (auto) otherwise we won't</span></span><br><span class="line"><span class="comment">			 * level out without new manual input */</span></span><br><span class="line">			_att_sp.roll_body = _manual.y * _parameters.man_roll_max_rad;</span><br><span class="line">			_att_sp.yaw_body = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_POSITION;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> altctrl_airspeed = get_demanded_airspeed();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* update desired altitude based on user pitch stick input */</span></span><br><span class="line">		<span class="keyword">bool</span> climbout_requested = update_desired_altitude(dt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if we assume that user is taking off then help by demanding altitude setpoint well above ground</span></span><br><span class="line">		<span class="comment">// and set limit to pitch angle to prevent steering into ground</span></span><br><span class="line">		<span class="comment">// this will only affect planes and not VTOL</span></span><br><span class="line">		<span class="keyword">float</span> pitch_limit_min = _parameters.pitch_limit_min;</span><br><span class="line">		do_takeoff_help(&amp;_hold_alt, &amp;pitch_limit_min);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* throttle limiting */</span></span><br><span class="line">		throttle_max = _parameters.throttle_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_land_detected.landed &amp;&amp; (fabsf(_manual.z) &lt; THROTTLE_THRESH)) &#123;</span><br><span class="line">			throttle_max = <span class="number">0.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(_hold_alt,</span><br><span class="line">					   altctrl_airspeed,</span><br><span class="line">					   radians(_parameters.pitch_limit_min),</span><br><span class="line">					   radians(_parameters.pitch_limit_max),</span><br><span class="line">					   _parameters.throttle_min,</span><br><span class="line">					   throttle_max,</span><br><span class="line">					   _parameters.throttle_cruise,</span><br><span class="line">					   climbout_requested,</span><br><span class="line">					   climbout_requested ? radians(<span class="number">10.0f</span>) : pitch_limit_min,</span><br><span class="line">					   tecs_status_s::TECS_MODE_NORMAL);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* heading control */</span></span><br><span class="line">		<span class="keyword">if</span> (fabsf(_manual.y) &lt; HDG_HOLD_MAN_INPUT_THRESH &amp;&amp;</span><br><span class="line">		    fabsf(_manual.r) &lt; HDG_HOLD_MAN_INPUT_THRESH) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* heading / roll is zero, lock onto current heading */</span></span><br><span class="line">			<span class="keyword">if</span> (fabsf(_att.yawspeed) &lt; HDG_HOLD_YAWRATE_THRESH &amp;&amp; !_yaw_lock_engaged) &#123;</span><br><span class="line">				<span class="comment">// little yaw movement, lock to current heading</span></span><br><span class="line">				_yaw_lock_engaged = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* user tries to do a takeoff in heading hold mode, reset the yaw setpoint on every iteration</span></span><br><span class="line"><span class="comment">			  to make sure the plane does not start rolling</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">			<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">				_hdg_hold_enabled = <span class="literal">false</span>;</span><br><span class="line">				_yaw_lock_engaged = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_yaw_lock_engaged) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* just switched back from non heading-hold to heading hold */</span></span><br><span class="line">				<span class="keyword">if</span> (!_hdg_hold_enabled) &#123;</span><br><span class="line">					_hdg_hold_enabled = <span class="literal">true</span>;</span><br><span class="line">					_hdg_hold_yaw = _yaw;</span><br><span class="line"></span><br><span class="line">					get_waypoint_heading_distance(_hdg_hold_yaw, _hdg_hold_prev_wp, _hdg_hold_curr_wp, <span class="literal">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* we have a valid heading hold position, are we too close? */</span></span><br><span class="line">				<span class="keyword">float</span> dist = get_distance_to_next_waypoint(_global_pos.lat, _global_pos.lon, _hdg_hold_curr_wp.lat,</span><br><span class="line">						_hdg_hold_curr_wp.lon);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (dist &lt; HDG_HOLD_REACHED_DIST) &#123;</span><br><span class="line">					get_waypoint_heading_distance(_hdg_hold_yaw, _hdg_hold_prev_wp, _hdg_hold_curr_wp, <span class="literal">false</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				Vector2f prev_wp&#123;(<span class="keyword">float</span>)_hdg_hold_prev_wp.lat, (<span class="keyword">float</span>)_hdg_hold_prev_wp.lon&#125;;</span><br><span class="line">				Vector2f curr_wp&#123;(<span class="keyword">float</span>)_hdg_hold_curr_wp.lat, (<span class="keyword">float</span>)_hdg_hold_curr_wp.lon&#125;;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* populate l1 control setpoint */</span></span><br><span class="line">				_l1_control.navigate_waypoints(prev_wp, curr_wp, curr_pos, ground_speed);</span><br><span class="line"></span><br><span class="line">				_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">				_att_sp.yaw_body = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (in_takeoff_situation()) &#123;</span><br><span class="line">					<span class="comment">/* limit roll motion to ensure enough lift */</span></span><br><span class="line">					_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, radians(<span class="number">-15.0f</span>), radians(<span class="number">15.0f</span>));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!_yaw_lock_engaged || fabsf(_manual.y) &gt;= HDG_HOLD_MAN_INPUT_THRESH ||</span><br><span class="line">		    fabsf(_manual.r) &gt;= HDG_HOLD_MAN_INPUT_THRESH) &#123;</span><br><span class="line"></span><br><span class="line">			_hdg_hold_enabled = <span class="literal">false</span>;</span><br><span class="line">			_yaw_lock_engaged = <span class="literal">false</span>;</span><br><span class="line">			_att_sp.roll_body = _manual.y * _parameters.man_roll_max_rad;</span><br><span class="line">			_att_sp.yaw_body = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">//如果是手工的纯高度控制</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode.flag_control_altitude_enabled) &#123;</span><br><span class="line">		<span class="comment">/* ALTITUDE CONTROL: pitch stick moves altitude setpoint, throttle stick sets airspeed */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_control_mode_current != FW_POSCTRL_MODE_POSITION &amp;&amp; _control_mode_current != FW_POSCTRL_MODE_ALTITUDE) &#123;</span><br><span class="line">			<span class="comment">/* Need to init because last loop iteration was in a different mode */</span></span><br><span class="line">			_hold_alt = _global_pos.alt;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_ALTITUDE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Get demanded airspeed */</span></span><br><span class="line">		<span class="keyword">float</span> altctrl_airspeed = get_demanded_airspeed();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* update desired altitude based on user pitch stick input */</span></span><br><span class="line">		<span class="keyword">bool</span> climbout_requested = update_desired_altitude(dt);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if we assume that user is taking off then help by demanding altitude setpoint well above ground</span></span><br><span class="line">		<span class="comment">// and set limit to pitch angle to prevent steering into ground</span></span><br><span class="line">		<span class="comment">// this will only affect planes and not VTOL</span></span><br><span class="line">		<span class="keyword">float</span> pitch_limit_min = _parameters.pitch_limit_min;</span><br><span class="line">		do_takeoff_help(&amp;_hold_alt, &amp;pitch_limit_min);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* throttle limiting */</span></span><br><span class="line">		throttle_max = _parameters.throttle_max;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_land_detected.landed &amp;&amp; (fabsf(_manual.z) &lt; THROTTLE_THRESH)) &#123;</span><br><span class="line">			throttle_max = <span class="number">0.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(_hold_alt,</span><br><span class="line">					   altctrl_airspeed,</span><br><span class="line">					   radians(_parameters.pitch_limit_min),</span><br><span class="line">					   radians(_parameters.pitch_limit_max),</span><br><span class="line">					   _parameters.throttle_min,</span><br><span class="line">					   throttle_max,</span><br><span class="line">					   _parameters.throttle_cruise,</span><br><span class="line">					   climbout_requested,</span><br><span class="line">					   climbout_requested ? radians(<span class="number">10.0f</span>) : pitch_limit_min,</span><br><span class="line">					   tecs_status_s::TECS_MODE_NORMAL);</span><br><span class="line"></span><br><span class="line">		_att_sp.roll_body = _manual.y * _parameters.man_roll_max_rad;</span><br><span class="line">		_att_sp.yaw_body = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果是手工，随性飞，既不控制高度，也不控制速度</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_control_mode_current = FW_POSCTRL_MODE_OTHER;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* do not publish the setpoint */</span></span><br><span class="line">		setpoint = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// reset hold altitude</span></span><br><span class="line">		_hold_alt = _global_pos.alt;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* reset landing and takeoff state */</span></span><br><span class="line">		<span class="keyword">if</span> (!_last_manual) &#123;</span><br><span class="line">			reset_landing_state();</span><br><span class="line">			reset_takeoff_state();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//广播的相关事宜，和飞控关系不大</span></span><br><span class="line">	<span class="comment">/* Copy thrust output for publication */</span></span><br><span class="line">	<span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp; <span class="comment">// launchdetector only available in auto</span></span><br><span class="line">	    pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF &amp;&amp;</span><br><span class="line">	    _launch_detection_state != LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS &amp;&amp;</span><br><span class="line">	    !_runway_takeoff.runwayTakeoffEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* making sure again that the correct thrust is used,</span></span><br><span class="line"><span class="comment">		 * without depending on library calls for safety reasons.</span></span><br><span class="line"><span class="comment">		   the pre-takeoff throttle and the idle throttle normally map to the same parameter. */</span></span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = _parameters.throttle_idle;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp;</span><br><span class="line">		   pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF &amp;&amp;</span><br><span class="line">		   _runway_takeoff.runwayTakeoffEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = _runway_takeoff.getThrottle(<span class="built_in">min</span>(get_tecs_thrust(), throttle_max));</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp;</span><br><span class="line">		   pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_IDLE) &#123;</span><br><span class="line"></span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_control_mode_current == FW_POSCTRL_MODE_OTHER) &#123;</span><br><span class="line">		_att_sp.thrust_body[<span class="number">0</span>] = <span class="built_in">min</span>(_att_sp.thrust_body[<span class="number">0</span>], _parameters.throttle_max);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Copy thrust and pitch values from tecs */</span></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_land_detected.landed) &#123;</span><br><span class="line">			<span class="comment">// when we are landed state we want the motor to spin at idle speed</span></span><br><span class="line">			_att_sp.thrust_body[<span class="number">0</span>] = <span class="built_in">min</span>(_parameters.throttle_idle, throttle_max);</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			_att_sp.thrust_body[<span class="number">0</span>] = <span class="built_in">min</span>(get_tecs_thrust(), throttle_max);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// decide when to use pitch setpoint from TECS because in some cases pitch</span></span><br><span class="line">	<span class="comment">// setpoint is generated by other means</span></span><br><span class="line">    <span class="comment">//之前已经确定了输出的roll，yaw（通过L1）;Throttle（通过TECS），而还没有确定Pitch要不要用TECS的结果，下面是一个复杂的条件判断。</span></span><br><span class="line">	<span class="keyword">bool</span> use_tecs_pitch = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// auto runway takeoff</span></span><br><span class="line">	use_tecs_pitch &amp;= !(_control_mode_current == FW_POSCTRL_MODE_AUTO &amp;&amp;</span><br><span class="line">			    pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_TAKEOFF &amp;&amp;</span><br><span class="line">			    (_launch_detection_state == LAUNCHDETECTION_RES_NONE || _runway_takeoff.runwayTakeoffEnabled()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// flaring during landing</span></span><br><span class="line">	use_tecs_pitch &amp;= !(pos_sp_curr.type == position_setpoint_s::SETPOINT_TYPE_LAND &amp;&amp; _land_noreturn_vertical);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// manual attitude control</span></span><br><span class="line">	use_tecs_pitch &amp;= !(_control_mode_current == FW_POSCTRL_MODE_OTHER);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (use_tecs_pitch) &#123;</span><br><span class="line">		_att_sp.pitch_body = get_tecs_pitch();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_control_mode.flag_control_position_enabled) &#123;</span><br><span class="line">		_last_manual = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_last_manual = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> setpoint;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用在control_position函数中，当输入的sp的类型是takeoff时调用。</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::control_takeoff(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed,</span><br><span class="line">		<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* current waypoint (the one currently heading for) */</span></span><br><span class="line">	<span class="function">Vector2f <span class="title">curr_wp</span><span class="params">((<span class="keyword">float</span>)pos_sp_curr.lat, (<span class="keyword">float</span>)pos_sp_curr.lon)</span></span>;</span><br><span class="line">	Vector2f prev_wp&#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>&#125;; <span class="comment">/* previous waypoint */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">		prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_prev.lat;</span><br><span class="line">		prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_prev.lon;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * No valid previous waypoint, go for the current wp.</span></span><br><span class="line"><span class="comment">		 * This is automatically handled by the L1 library.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_curr.lat;</span><br><span class="line">		prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_curr.lon;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// apply flaps for takeoff according to the corresponding scale factor set</span></span><br><span class="line">	<span class="comment">// via FW_FLAPS_TO_SCL</span></span><br><span class="line">	_att_sp.apply_flaps = vehicle_attitude_setpoint_s::FLAPS_TAKEOFF;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// continuously reset launch detection and runway takeoff until armed</span></span><br><span class="line">	<span class="keyword">if</span> (!_control_mode.flag_armed) &#123;</span><br><span class="line">		_launchDetector.reset();</span><br><span class="line">		_launch_detection_state = LAUNCHDETECTION_RES_NONE;</span><br><span class="line">		_launch_detection_notify = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_runway_takeoff.runwayTakeoffEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!_runway_takeoff.isInitialized()) &#123;</span><br><span class="line">			<span class="function">Eulerf <span class="title">euler</span><span class="params">(Quatf(_att.q))</span></span>;</span><br><span class="line">			_runway_takeoff.init(euler.psi(), _global_pos.lat, _global_pos.lon);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* need this already before takeoff is detected</span></span><br><span class="line"><span class="comment">			 * doesn't matter if it gets reset when takeoff is detected eventually */</span></span><br><span class="line">			_takeoff_ground_alt = _global_pos.alt;</span><br><span class="line"></span><br><span class="line">			mavlink_log_info(&amp;_mavlink_log_pub, <span class="string">"Takeoff on runway"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> terrain_alt = get_terrain_altitude_takeoff(_takeoff_ground_alt, _global_pos);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// update runway takeoff helper</span></span><br><span class="line">		_runway_takeoff.update(_airspeed, _global_pos.alt - terrain_alt,</span><br><span class="line">				       _global_pos.lat, _global_pos.lon, &amp;_mavlink_log_pub);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Update navigation: _runway_takeoff returns the start WP according to mode and phase.</span></span><br><span class="line"><span class="comment">		 * If we use the navigator heading or not is decided later.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		_l1_control.navigate_waypoints(_runway_takeoff.getStartWP(), curr_wp, curr_pos, ground_speed);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// update tecs</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> takeoff_pitch_max_deg = _runway_takeoff.getMaxPitch(_parameters.pitch_limit_max);</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(pos_sp_curr.alt,</span><br><span class="line">					   calculate_target_airspeed(_runway_takeoff.getMinAirspeedScaling() * _parameters.airspeed_min),</span><br><span class="line">					   radians(_parameters.pitch_limit_min),</span><br><span class="line">					   radians(takeoff_pitch_max_deg),</span><br><span class="line">					   _parameters.throttle_min,</span><br><span class="line">					   _parameters.throttle_max, <span class="comment">// XXX should we also set runway_takeoff_throttle here?</span></span><br><span class="line">					   _parameters.throttle_cruise,</span><br><span class="line">					   _runway_takeoff.climbout(),</span><br><span class="line">					   radians(_runway_takeoff.getMinPitch(pos_sp_curr.pitch_min, <span class="number">10.0f</span>, _parameters.pitch_limit_min)),</span><br><span class="line">					   tecs_status_s::TECS_MODE_TAKEOFF);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// assign values</span></span><br><span class="line">		_att_sp.roll_body = _runway_takeoff.getRoll(_l1_control.get_roll_setpoint());</span><br><span class="line">		_att_sp.yaw_body = _runway_takeoff.getYaw(_l1_control.nav_bearing());</span><br><span class="line">		_att_sp.fw_control_yaw = _runway_takeoff.controlYaw();</span><br><span class="line">		_att_sp.pitch_body = _runway_takeoff.getPitch(get_tecs_pitch());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// reset integrals except yaw (which also counts for the wheel controller)</span></span><br><span class="line">		_att_sp.roll_reset_integral = _runway_takeoff.resetIntegrators();</span><br><span class="line">		_att_sp.pitch_reset_integral = _runway_takeoff.resetIntegrators();</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Perform launch detection */</span></span><br><span class="line">		<span class="keyword">if</span> (_launchDetector.launchDetectionEnabled() &amp;&amp;</span><br><span class="line">		    _launch_detection_state != LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_control_mode.flag_armed) &#123;</span><br><span class="line">				<span class="comment">/* Perform launch detection */</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Inform user that launchdetection is running every 4s */</span></span><br><span class="line">				<span class="keyword">if</span> (hrt_elapsed_time(&amp;_launch_detection_notify) &gt; <span class="number">4e6</span>) &#123;</span><br><span class="line">					mavlink_log_critical(&amp;_mavlink_log_pub, <span class="string">"Launch detection running"</span>);</span><br><span class="line">					_launch_detection_notify = hrt_absolute_time();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Detect launch using body X (forward) acceleration */</span></span><br><span class="line">				_launchDetector.update(_sub_sensors.<span class="built_in">get</span>().accel_x);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* update our copy of the launch detection state */</span></span><br><span class="line">				_launch_detection_state = _launchDetector.getLaunchDetected();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span>	&#123;</span><br><span class="line">			<span class="comment">/* no takeoff detection --&gt; fly */</span></span><br><span class="line">			_launch_detection_state = LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Set control values depending on the detection state */</span></span><br><span class="line">		<span class="keyword">if</span> (_launch_detection_state != LAUNCHDETECTION_RES_NONE) &#123;</span><br><span class="line">			<span class="comment">/* Launch has been detected, hence we have to control the plane. */</span></span><br><span class="line"></span><br><span class="line">			_l1_control.navigate_waypoints(prev_wp, curr_wp, curr_pos, ground_speed);</span><br><span class="line">			_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">			_att_sp.yaw_body = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Select throttle: only in LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS we want to use</span></span><br><span class="line"><span class="comment">			 * full throttle, otherwise we use idle throttle */</span></span><br><span class="line">			<span class="keyword">float</span> takeoff_throttle = _parameters.throttle_max;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_launch_detection_state != LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS) &#123;</span><br><span class="line">				takeoff_throttle = _parameters.throttle_idle;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* select maximum pitch: the launchdetector may impose another limit for the pitch</span></span><br><span class="line"><span class="comment">			 * depending on the state of the launch */</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> takeoff_pitch_max_deg = _launchDetector.getPitchMax(_parameters.pitch_limit_max);</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> altitude_error = pos_sp_curr.alt - _global_pos.alt;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* apply minimum pitch and limit roll if target altitude is not within climbout_diff meters */</span></span><br><span class="line">			<span class="keyword">if</span> (_parameters.climbout_diff &gt; <span class="number">0.0f</span> &amp;&amp; altitude_error &gt; _parameters.climbout_diff) &#123;</span><br><span class="line">				<span class="comment">/* enforce a minimum of 10 degrees pitch up on takeoff, or take parameter */</span></span><br><span class="line">				tecs_update_pitch_throttle(pos_sp_curr.alt,</span><br><span class="line">							   _parameters.airspeed_trim,</span><br><span class="line">							   radians(_parameters.pitch_limit_min),</span><br><span class="line">							   radians(takeoff_pitch_max_deg),</span><br><span class="line">							   _parameters.throttle_min,</span><br><span class="line">							   takeoff_throttle,</span><br><span class="line">							   _parameters.throttle_cruise,</span><br><span class="line">							   <span class="literal">true</span>,</span><br><span class="line">							   <span class="built_in">max</span>(radians(pos_sp_curr.pitch_min), radians(<span class="number">10.0f</span>)),</span><br><span class="line">							   tecs_status_s::TECS_MODE_TAKEOFF);</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* limit roll motion to ensure enough lift */</span></span><br><span class="line">				_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, radians(<span class="number">-15.0f</span>), radians(<span class="number">15.0f</span>));</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				tecs_update_pitch_throttle(pos_sp_curr.alt,</span><br><span class="line">							   calculate_target_airspeed(_parameters.airspeed_trim),</span><br><span class="line">							   radians(_parameters.pitch_limit_min),</span><br><span class="line">							   radians(_parameters.pitch_limit_max),</span><br><span class="line">							   _parameters.throttle_min,</span><br><span class="line">							   takeoff_throttle,</span><br><span class="line">							   _parameters.throttle_cruise,</span><br><span class="line">							   <span class="literal">false</span>,</span><br><span class="line">							   radians(_parameters.pitch_limit_min));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* Tell the attitude controller to stop integrating while we are waiting</span></span><br><span class="line"><span class="comment">			 * for the launch */</span></span><br><span class="line">			_att_sp.roll_reset_integral = <span class="literal">true</span>;</span><br><span class="line">			_att_sp.pitch_reset_integral = <span class="literal">true</span>;</span><br><span class="line">			_att_sp.yaw_reset_integral = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Set default roll and pitch setpoints during detection phase */</span></span><br><span class="line">			_att_sp.roll_body = <span class="number">0.0f</span>;</span><br><span class="line">			_att_sp.pitch_body = <span class="built_in">max</span>(radians(pos_sp_curr.pitch_min), radians(<span class="number">10.0f</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用在control_position函数中，当输入的sp的类型是land时调用。</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::control_landing(<span class="keyword">const</span> Vector2f &amp;curr_pos, <span class="keyword">const</span> Vector2f &amp;ground_speed,</span><br><span class="line">		<span class="keyword">const</span> position_setpoint_s &amp;pos_sp_prev, <span class="keyword">const</span> position_setpoint_s &amp;pos_sp_curr)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* current waypoint (the one currently heading for) */</span></span><br><span class="line">	<span class="function">Vector2f <span class="title">curr_wp</span><span class="params">((<span class="keyword">float</span>)pos_sp_curr.lat, (<span class="keyword">float</span>)pos_sp_curr.lon)</span></span>;</span><br><span class="line">	Vector2f prev_wp&#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>&#125;; <span class="comment">/* previous waypoint */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">		prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_prev.lat;</span><br><span class="line">		prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_prev.lon;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * No valid previous waypoint, go for the current wp.</span></span><br><span class="line"><span class="comment">		 * This is automatically handled by the L1 library.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		prev_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)pos_sp_curr.lat;</span><br><span class="line">		prev_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)pos_sp_curr.lon;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// apply full flaps for landings. this flag will also trigger the use of flaperons</span></span><br><span class="line">	<span class="comment">// if they have been enabled using the corresponding parameter</span></span><br><span class="line">	_att_sp.apply_flaps = vehicle_attitude_setpoint_s::FLAPS_LAND;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enable tighter throttle control for landings</span></span><br><span class="line">	_tecs.set_time_const_throt(_parameters.land_throtTC_scale * _parameters.time_const_throt);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// save time at which we started landing and reset abort_landing</span></span><br><span class="line">	<span class="keyword">if</span> (_time_started_landing == <span class="number">0</span>) &#123;</span><br><span class="line">		reset_landing_state();</span><br><span class="line">		_time_started_landing = hrt_absolute_time();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> bearing_airplane_currwp = get_bearing_to_next_waypoint((<span class="keyword">double</span>)curr_pos(<span class="number">0</span>), (<span class="keyword">double</span>)curr_pos(<span class="number">1</span>),</span><br><span class="line">					      (<span class="keyword">double</span>)curr_wp(<span class="number">0</span>), (<span class="keyword">double</span>)curr_wp(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> bearing_lastwp_currwp = bearing_airplane_currwp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">		bearing_lastwp_currwp = get_bearing_to_next_waypoint((<span class="keyword">double</span>)prev_wp(<span class="number">0</span>), (<span class="keyword">double</span>)prev_wp(<span class="number">1</span>), (<span class="keyword">double</span>)curr_wp(<span class="number">0</span>),</span><br><span class="line">					(<span class="keyword">double</span>)curr_wp(<span class="number">1</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Horizontal landing control */</span></span><br><span class="line">	<span class="comment">/* switch to heading hold for the last meters, continue heading hold after */</span></span><br><span class="line">	<span class="keyword">float</span> wp_distance = get_distance_to_next_waypoint((<span class="keyword">double</span>)curr_pos(<span class="number">0</span>), (<span class="keyword">double</span>)curr_pos(<span class="number">1</span>), (<span class="keyword">double</span>)curr_wp(<span class="number">0</span>),</span><br><span class="line">			    (<span class="keyword">double</span>)curr_wp(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* calculate a waypoint distance value which is 0 when the aircraft is behind the waypoint */</span></span><br><span class="line">	<span class="keyword">float</span> wp_distance_save = wp_distance;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fabsf(wrap_pi(bearing_airplane_currwp - bearing_lastwp_currwp)) &gt;= radians(<span class="number">90.0f</span>)) &#123;</span><br><span class="line">		wp_distance_save = <span class="number">0.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create virtual waypoint which is on the desired flight path but</span></span><br><span class="line">	<span class="comment">// some distance behind landing waypoint. This will make sure that the plane</span></span><br><span class="line">	<span class="comment">// will always follow the desired flight path even if we get close or past</span></span><br><span class="line">	<span class="comment">// the landing waypoint</span></span><br><span class="line">	<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">		<span class="keyword">double</span> lat = pos_sp_curr.lat;</span><br><span class="line">		<span class="keyword">double</span> lon = pos_sp_curr.lon;</span><br><span class="line"></span><br><span class="line">		create_waypoint_from_line_and_dist(pos_sp_curr.lat, pos_sp_curr.lon,</span><br><span class="line">						   pos_sp_prev.lat, pos_sp_prev.lon, <span class="number">-1000.0f</span>, &amp;lat, &amp;lon);</span><br><span class="line"></span><br><span class="line">		curr_wp(<span class="number">0</span>) = (<span class="keyword">float</span>)lat;</span><br><span class="line">		curr_wp(<span class="number">1</span>) = (<span class="keyword">float</span>)lon;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// we want the plane to keep tracking the desired flight path until we start flaring</span></span><br><span class="line">	<span class="comment">// if we go into heading hold mode earlier then we risk to be pushed away from the runway by cross winds</span></span><br><span class="line">	<span class="keyword">if</span> ((_parameters.land_heading_hold_horizontal_distance &gt; <span class="number">0.0f</span>) &amp;&amp; !_land_noreturn_horizontal &amp;&amp;</span><br><span class="line">	    ((wp_distance &lt; _parameters.land_heading_hold_horizontal_distance) || _land_noreturn_vertical)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">			<span class="comment">/* heading hold, along the line connecting this and the last waypoint */</span></span><br><span class="line">			_target_bearing = bearing_lastwp_currwp;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			_target_bearing = _yaw;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_land_noreturn_horizontal = <span class="literal">true</span>;</span><br><span class="line">		mavlink_log_info(&amp;_mavlink_log_pub, <span class="string">"Landing, heading hold"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_land_noreturn_horizontal) &#123;</span><br><span class="line">		<span class="comment">// heading hold</span></span><br><span class="line">		_l1_control.navigate_heading(_target_bearing, _yaw, ground_speed);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// normal navigation</span></span><br><span class="line">		_l1_control.navigate_waypoints(prev_wp, curr_wp, curr_pos, ground_speed);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_att_sp.roll_body = _l1_control.get_roll_setpoint();</span><br><span class="line">	_att_sp.yaw_body = _l1_control.nav_bearing();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_land_noreturn_horizontal) &#123;</span><br><span class="line">		<span class="comment">/* limit roll motion to prevent wings from touching the ground first */</span></span><br><span class="line">		_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, radians(<span class="number">-10.0f</span>), radians(<span class="number">10.0f</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Vertical landing control */</span></span><br><span class="line">	<span class="comment">/* apply minimum pitch (flare) and limit roll if close to touch down, altitude error is negative (going down) */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// default to no terrain estimation, just use landing waypoint altitude</span></span><br><span class="line">	<span class="keyword">float</span> terrain_alt = pos_sp_curr.alt;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_parameters.land_use_terrain_estimate == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (_global_pos.terrain_alt_valid) &#123;</span><br><span class="line">			<span class="comment">// all good, have valid terrain altitude</span></span><br><span class="line">			terrain_alt = _global_pos.terrain_alt;</span><br><span class="line">			_t_alt_prev_valid = terrain_alt;</span><br><span class="line">			_time_last_t_alt = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_time_last_t_alt == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// we have started landing phase but don't have valid terrain</span></span><br><span class="line">			<span class="comment">// wait for some time, maybe we will soon get a valid estimate</span></span><br><span class="line">			<span class="comment">// until then just use the altitude of the landing waypoint</span></span><br><span class="line">			<span class="keyword">if</span> (hrt_elapsed_time(&amp;_time_started_landing) &lt; <span class="number">10</span>_s) &#123;</span><br><span class="line">				terrain_alt = pos_sp_curr.alt;</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// still no valid terrain, abort landing</span></span><br><span class="line">				terrain_alt = pos_sp_curr.alt;</span><br><span class="line">				abort_landing(<span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!_global_pos.terrain_alt_valid &amp;&amp; hrt_elapsed_time(&amp;_time_last_t_alt) &lt; T_ALT_TIMEOUT)</span><br><span class="line">			   || _land_noreturn_vertical) &#123;</span><br><span class="line">			<span class="comment">// use previous terrain estimate for some time and hope to recover</span></span><br><span class="line">			<span class="comment">// if we are already flaring (land_noreturn_vertical) then just</span></span><br><span class="line">			<span class="comment">//  go with the old estimate</span></span><br><span class="line">			terrain_alt = _t_alt_prev_valid;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// terrain alt was not valid for long time, abort landing</span></span><br><span class="line">			terrain_alt = _t_alt_prev_valid;</span><br><span class="line">			abort_landing(<span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Check if we should start flaring with a vertical and a</span></span><br><span class="line"><span class="comment">	 * horizontal limit (with some tolerance)</span></span><br><span class="line"><span class="comment">	 * The horizontal limit is only applied when we are in front of the wp</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((_global_pos.alt &lt; terrain_alt + _landingslope.flare_relative_alt()) ||</span><br><span class="line">	    _land_noreturn_vertical) &#123;  <span class="comment">//checking for land_noreturn to avoid unwanted climb out</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* land with minimal speed */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* force TECS to only control speed with pitch, altitude is only implicitly controlled now */</span></span><br><span class="line">		<span class="comment">// _tecs.set_speed_weight(2.0f);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* kill the throttle if param requests it */</span></span><br><span class="line">		<span class="keyword">float</span> throttle_max = _parameters.throttle_max;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* enable direct yaw control using rudder/wheel */</span></span><br><span class="line">		<span class="keyword">if</span> (_land_noreturn_horizontal) &#123;</span><br><span class="line">			_att_sp.yaw_body = _target_bearing;</span><br><span class="line">			_att_sp.fw_control_yaw = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (((_global_pos.alt &lt; terrain_alt + _landingslope.motor_lim_relative_alt()) &amp;&amp;</span><br><span class="line">		     (wp_distance_save &lt; _landingslope.flare_length() + <span class="number">5.0f</span>)) || <span class="comment">// Only kill throttle when close to WP</span></span><br><span class="line">		    _land_motor_lim) &#123;</span><br><span class="line">			throttle_max = <span class="built_in">min</span>(throttle_max, _parameters.throttle_land_max);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!_land_motor_lim) &#123;</span><br><span class="line">				_land_motor_lim  = <span class="literal">true</span>;</span><br><span class="line">				mavlink_log_info(&amp;_mavlink_log_pub, <span class="string">"Landing, limiting throttle"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> flare_curve_alt_rel = _landingslope.getFlareCurveRelativeAltitudeSave(wp_distance, bearing_lastwp_currwp,</span><br><span class="line">					    bearing_airplane_currwp);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* avoid climbout */</span></span><br><span class="line">		<span class="keyword">if</span> ((_flare_curve_alt_rel_last &lt; flare_curve_alt_rel &amp;&amp; _land_noreturn_vertical) || _land_stayonground) &#123;</span><br><span class="line">			flare_curve_alt_rel = <span class="number">0.0f</span>; <span class="comment">// stay on ground</span></span><br><span class="line">			_land_stayonground = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> airspeed_land = _parameters.land_airspeed_scale * _parameters.airspeed_min;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> throttle_land = _parameters.throttle_min + (_parameters.throttle_max - _parameters.throttle_min) * <span class="number">0.1f</span>;</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(terrain_alt + flare_curve_alt_rel,</span><br><span class="line">					   calculate_target_airspeed(airspeed_land),</span><br><span class="line">					   radians(_parameters.land_flare_pitch_min_deg),</span><br><span class="line">					   radians(_parameters.land_flare_pitch_max_deg),</span><br><span class="line">					   <span class="number">0.0f</span>,</span><br><span class="line">					   throttle_max,</span><br><span class="line">					   throttle_land,</span><br><span class="line">					   <span class="literal">false</span>,</span><br><span class="line">					   _land_motor_lim ? radians(_parameters.land_flare_pitch_min_deg) : radians(_parameters.pitch_limit_min),</span><br><span class="line">					   _land_motor_lim ? tecs_status_s::TECS_MODE_LAND_THROTTLELIM : tecs_status_s::TECS_MODE_LAND);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!_land_noreturn_vertical) &#123;</span><br><span class="line">			<span class="comment">// just started with the flaring phase</span></span><br><span class="line">			_flare_pitch_sp = <span class="number">0.0f</span>;</span><br><span class="line">			_flare_height = _global_pos.alt - terrain_alt;</span><br><span class="line">			mavlink_log_info(&amp;_mavlink_log_pub, <span class="string">"Landing, flaring"</span>);</span><br><span class="line">			_land_noreturn_vertical = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (_global_pos.vel_d &gt; <span class="number">0.1f</span>) &#123;</span><br><span class="line">				_flare_pitch_sp = radians(_parameters.land_flare_pitch_min_deg) *</span><br><span class="line">						  <span class="built_in">constrain</span>((_flare_height - (_global_pos.alt - terrain_alt)) / _flare_height, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// otherwise continue using previous _flare_pitch_sp</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_att_sp.pitch_body = _flare_pitch_sp;</span><br><span class="line">		_flare_curve_alt_rel_last = flare_curve_alt_rel;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* intersect glide slope:</span></span><br><span class="line"><span class="comment">		 * minimize speed to approach speed</span></span><br><span class="line"><span class="comment">		 * if current position is higher than the slope follow the glide slope (sink to the</span></span><br><span class="line"><span class="comment">		 * glide slope)</span></span><br><span class="line"><span class="comment">		 * also if the system captures the slope it should stay</span></span><br><span class="line"><span class="comment">		 * on the slope (bool land_onslope)</span></span><br><span class="line"><span class="comment">		 * if current position is below the slope continue at previous wp altitude</span></span><br><span class="line"><span class="comment">		 * until the intersection with slope</span></span><br><span class="line"><span class="comment">		 * */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">float</span> altitude_desired = terrain_alt;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> landing_slope_alt_rel_desired = _landingslope.getLandingSlopeRelativeAltitudeSave(wp_distance,</span><br><span class="line">				bearing_lastwp_currwp, bearing_airplane_currwp);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_global_pos.alt &gt; terrain_alt + landing_slope_alt_rel_desired || _land_onslope) &#123;</span><br><span class="line">			<span class="comment">/* stay on slope */</span></span><br><span class="line">			altitude_desired = terrain_alt + landing_slope_alt_rel_desired;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!_land_onslope) &#123;</span><br><span class="line">				mavlink_log_info(&amp;_mavlink_log_pub, <span class="string">"Landing, on slope"</span>);</span><br><span class="line">				_land_onslope = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* continue horizontally */</span></span><br><span class="line">			<span class="keyword">if</span> (pos_sp_prev.valid) &#123;</span><br><span class="line">				altitude_desired = pos_sp_prev.alt;</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				altitude_desired = _global_pos.alt;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">float</span> airspeed_approach = _parameters.land_airspeed_scale * _parameters.airspeed_min;</span><br><span class="line"></span><br><span class="line">		tecs_update_pitch_throttle(altitude_desired,</span><br><span class="line">					   calculate_target_airspeed(airspeed_approach),</span><br><span class="line">					   radians(_parameters.pitch_limit_min),</span><br><span class="line">					   radians(_parameters.pitch_limit_max),</span><br><span class="line">					   _parameters.throttle_min,</span><br><span class="line">					   _parameters.throttle_max,</span><br><span class="line">					   _parameters.throttle_cruise,</span><br><span class="line">					   <span class="literal">false</span>,</span><br><span class="line">					   radians(_parameters.pitch_limit_min));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span></span><br><span class="line">FixedwingPositionControl::get_tecs_pitch()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_is_tecs_running) &#123;</span><br><span class="line">		<span class="keyword">return</span> _tecs.get_pitch_setpoint();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return 0 to prevent stale tecs state when it's not running</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span></span><br><span class="line">FixedwingPositionControl::get_tecs_thrust()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (_is_tecs_running) &#123;</span><br><span class="line">		<span class="keyword">return</span> _tecs.get_throttle_setpoint();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return 0 to prevent stale tecs state when it's not running</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::handle_command()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (_vehicle_command.command == vehicle_command_s::VEHICLE_CMD_DO_GO_AROUND) &#123;</span><br><span class="line">		<span class="comment">// only abort landing before point of no return (horizontal and vertical)</span></span><br><span class="line">		<span class="keyword">if</span> (_control_mode.flag_control_auto_enabled &amp;&amp;</span><br><span class="line">		    _pos_sp_triplet.current.valid &amp;&amp;</span><br><span class="line">		    _pos_sp_triplet.current.type == position_setpoint_s::SETPOINT_TYPE_LAND) &#123;</span><br><span class="line"></span><br><span class="line">			abort_landing(<span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::<span class="built_in">run</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * do subscriptions</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//定义sub句柄</span></span><br><span class="line">	_global_pos_sub = orb_subscribe(ORB_ID(vehicle_global_position));</span><br><span class="line">	_local_pos_sub = orb_subscribe(ORB_ID(vehicle_local_position));</span><br><span class="line">	_pos_sp_triplet_sub = orb_subscribe(ORB_ID(position_setpoint_triplet));</span><br><span class="line">	_control_mode_sub = orb_subscribe(ORB_ID(vehicle_control_mode));</span><br><span class="line">	_vehicle_attitude_sub = orb_subscribe(ORB_ID(vehicle_attitude));</span><br><span class="line">	_vehicle_command_sub = orb_subscribe(ORB_ID(vehicle_command));</span><br><span class="line">	_vehicle_status_sub = orb_subscribe(ORB_ID(vehicle_status));</span><br><span class="line">	_vehicle_land_detected_sub = orb_subscribe(ORB_ID(vehicle_land_detected));</span><br><span class="line">	_params_sub = orb_subscribe(ORB_ID(parameter_update));</span><br><span class="line">	_manual_control_sub = orb_subscribe(ORB_ID(manual_control_setpoint));</span><br><span class="line">	_sensor_baro_sub = orb_subscribe(ORB_ID(sensor_baro));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置每次迭代间隔为20ms</span></span><br><span class="line">	<span class="comment">/* rate limit position updates to 50 Hz */</span></span><br><span class="line">	orb_set_interval(_global_pos_sub, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* abort on a nonzero return value from the parameter init */</span></span><br><span class="line">	<span class="keyword">if</span> (parameters_update() != PX4_OK) &#123;</span><br><span class="line">		<span class="comment">/* parameter setup went wrong, abort */</span></span><br><span class="line">		PX4_ERR(<span class="string">"aborting startup due to errors."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* wakeup source(s) */</span></span><br><span class="line">	<span class="keyword">px4_pollfd_struct_t</span> fds[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Setup of loop */</span></span><br><span class="line">    <span class="comment">//fds中只保存全球位置信息，也就是说，我们只在意全球位置信息发生变化这个事件</span></span><br><span class="line">	fds[<span class="number">0</span>].fd = _global_pos_sub;</span><br><span class="line">	fds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (!should_exit()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* wait for up to 500ms for data */</span></span><br><span class="line">        <span class="comment">//这里官方源码说错了，应该是等待参数更新，直到100ms</span></span><br><span class="line">		<span class="keyword">int</span> pret = px4_poll(&amp;fds[<span class="number">0</span>], (<span class="keyword">sizeof</span>(fds) / <span class="keyword">sizeof</span>(fds[<span class="number">0</span>])), <span class="number">100</span>);</span><br><span class="line">        <span class="comment">//下面两个if语句是对订阅更新过程出现bug的处理，如果订阅出错，程序直接进入下次循环</span></span><br><span class="line">		<span class="comment">/* timed out - periodic check for _task_should_exit, etc. */</span></span><br><span class="line">		<span class="keyword">if</span> (pret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* this is undesirable but not much we can do - might want to flag unhappy status */</span></span><br><span class="line">		<span class="keyword">if</span> (pret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			PX4_WARN(<span class="string">"poll error %d, %d"</span>, pret, errno);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* only update parameters if they changed */</span></span><br><span class="line">        <span class="comment">//如果正常接收到了更新的参数，那么执行下面的代码：</span></span><br><span class="line">        <span class="keyword">bool</span> params_updated = <span class="literal">false</span>;</span><br><span class="line">        orb_check(_params_sub, &amp;params_updated);<span class="comment">//检查订阅的飞行参数更新了没</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果更新了，就更新本地储存的飞行参数</span></span><br><span class="line">		<span class="keyword">if</span> (params_updated) &#123;</span><br><span class="line">			<span class="comment">/* read from param to clear updated flag */</span></span><br><span class="line">			parameter_update_s update;</span><br><span class="line">			orb_copy(ORB_ID(parameter_update), _params_sub, &amp;update);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* update parameters from storage */</span></span><br><span class="line">			parameters_update();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* only run controller if position changed */</span></span><br><span class="line">        <span class="comment">//如果检测到飞机的全球位置发生改变</span></span><br><span class="line">		<span class="keyword">if</span> ((fds[<span class="number">0</span>].revents &amp; POLLIN) != <span class="number">0</span>) &#123;</span><br><span class="line">			perf_begin(_loop_perf);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* load local copies */</span></span><br><span class="line">            <span class="comment">//在本地更新储存最新的全球位置和本地位置</span></span><br><span class="line">			orb_copy(ORB_ID(vehicle_global_position), _global_pos_sub, &amp;_global_pos);</span><br><span class="line">			orb_copy(ORB_ID(vehicle_local_position), _local_pos_sub, &amp;_local_pos);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// handle estimator reset events. we only adjust setpoins for manual modes</span></span><br><span class="line">            <span class="comment">//如果是手动控制,进行高度的互补滤波</span></span><br><span class="line">			<span class="keyword">if</span> (_control_mode.flag_control_manual_enabled) &#123;</span><br><span class="line">				<span class="keyword">if</span> (_control_mode.flag_control_altitude_enabled &amp;&amp; _global_pos.alt_reset_counter != _alt_reset_counter) &#123;</span><br><span class="line">                    _hold_alt += _global_pos.delta_alt;</span><br><span class="line">					<span class="comment">// make TECS accept step in altitude and demanded altitude</span></span><br><span class="line">                    _tecs.handle_alt_step(_global_pos.delta_alt, _global_pos.alt);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// adjust navigation waypoints in position control mode</span></span><br><span class="line">				<span class="keyword">if</span> (_control_mode.flag_control_altitude_enabled &amp;&amp; _control_mode.flag_control_velocity_enabled</span><br><span class="line">				    &amp;&amp; _global_pos.lat_lon_reset_counter != _pos_reset_counter) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// reset heading hold flag, which will re-initialise position control</span></span><br><span class="line">					_hdg_hold_enabled = <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// update the reset counters in any case</span></span><br><span class="line">			_alt_reset_counter = _global_pos.alt_reset_counter;</span><br><span class="line">			_pos_reset_counter = _global_pos.lat_lon_reset_counter;</span><br><span class="line"></span><br><span class="line">			_sub_sensors.update();</span><br><span class="line">			airspeed_poll();</span><br><span class="line">			manual_control_setpoint_poll();</span><br><span class="line">			position_setpoint_triplet_poll();</span><br><span class="line">			vehicle_attitude_poll();</span><br><span class="line">			vehicle_command_poll();</span><br><span class="line">			vehicle_control_mode_poll();</span><br><span class="line">			vehicle_land_detected_poll();</span><br><span class="line">			vehicle_status_poll();</span><br><span class="line"></span><br><span class="line">			<span class="function">Vector2f <span class="title">curr_pos</span><span class="params">((<span class="keyword">float</span>)_global_pos.lat, (<span class="keyword">float</span>)_global_pos.lon)</span></span>;</span><br><span class="line">			<span class="function">Vector2f <span class="title">ground_speed</span><span class="params">(_global_pos.vel_n, _global_pos.vel_e)</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Attempt to control position, on success (= sensors present and not in manual mode),</span></span><br><span class="line"><span class="comment">			 * publish setpoint.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//尝试进入control_position函数，如果返回true说明函数给出了setpoint。</span></span><br><span class="line">			<span class="keyword">if</span> (control_position(curr_pos, ground_speed, _pos_sp_triplet.previous, _pos_sp_triplet.current, _pos_sp_triplet.next)) &#123;</span><br><span class="line">				_att_sp.timestamp = hrt_absolute_time();</span><br><span class="line">                <span class="comment">//正常完成一次position control的迭代之后</span></span><br><span class="line">				<span class="comment">// add attitude setpoint offsets</span></span><br><span class="line">                <span class="comment">//给setpoint加上偏置</span></span><br><span class="line">				_att_sp.roll_body += _parameters.rollsp_offset_rad;</span><br><span class="line">				_att_sp.pitch_body += _parameters.pitchsp_offset_rad;</span><br><span class="line">                <span class="comment">//如果是手动模式，还要检查输出的值是否在范围内。</span></span><br><span class="line">				<span class="keyword">if</span> (_control_mode.flag_control_manual_enabled) &#123;</span><br><span class="line">					_att_sp.roll_body = <span class="built_in">constrain</span>(_att_sp.roll_body, -_parameters.man_roll_max_rad, _parameters.man_roll_max_rad);</span><br><span class="line">					_att_sp.pitch_body = <span class="built_in">constrain</span>(_att_sp.pitch_body, -_parameters.man_pitch_max_rad, _parameters.man_pitch_max_rad);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//生成四元数矩阵</span></span><br><span class="line">				<span class="function">Quatf <span class="title">q</span><span class="params">(Eulerf(_att_sp.roll_body, _att_sp.pitch_body, _att_sp.yaw_body))</span></span>;</span><br><span class="line">				q.copyTo(_att_sp.q_d);</span><br><span class="line">				_att_sp.q_d_valid = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//setpoint的广播事宜</span></span><br><span class="line">				<span class="keyword">if</span> (!_control_mode.flag_control_offboard_enabled ||</span><br><span class="line">				    _control_mode.flag_control_position_enabled ||</span><br><span class="line">				    _control_mode.flag_control_velocity_enabled ||</span><br><span class="line">				    _control_mode.flag_control_acceleration_enabled) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="comment">/* lazily publish the setpoint only once available */</span></span><br><span class="line">					<span class="keyword">if</span> (_attitude_sp_pub != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">						<span class="comment">/* publish the attitude setpoint */</span></span><br><span class="line">						orb_publish(_attitude_setpoint_id, _attitude_sp_pub, &amp;_att_sp);</span><br><span class="line"></span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_attitude_setpoint_id != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">						<span class="comment">/* advertise and publish */</span></span><br><span class="line">						_attitude_sp_pub = orb_advertise(_attitude_setpoint_id, &amp;_att_sp);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// only publish status in full FW mode</span></span><br><span class="line">					<span class="keyword">if</span> (!_vehicle_status.is_rotary_wing &amp;&amp; !_vehicle_status.in_transition_mode) &#123;</span><br><span class="line">						status_publish();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			perf_end(_loop_perf);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::reset_takeoff_state(<span class="keyword">bool</span> force)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// only reset takeoff if !armed or just landed</span></span><br><span class="line">	<span class="keyword">if</span> (!_control_mode.flag_armed || (_was_in_air &amp;&amp; _vehicle_land_detected.landed) || force) &#123;</span><br><span class="line"></span><br><span class="line">		_runway_takeoff.reset();</span><br><span class="line"></span><br><span class="line">		_launchDetector.reset();</span><br><span class="line">		_launch_detection_state = LAUNCHDETECTION_RES_NONE;</span><br><span class="line">		_launch_detection_notify = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_launch_detection_state = LAUNCHDETECTION_RES_DETECTED_ENABLEMOTORS;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::reset_landing_state()</span><br><span class="line">&#123;</span><br><span class="line">	_time_started_landing = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// reset terrain estimation relevant values</span></span><br><span class="line">	_time_last_t_alt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	_land_noreturn_horizontal = <span class="literal">false</span>;</span><br><span class="line">	_land_noreturn_vertical = <span class="literal">false</span>;</span><br><span class="line">	_land_stayonground = <span class="literal">false</span>;</span><br><span class="line">	_land_motor_lim = <span class="literal">false</span>;</span><br><span class="line">	_land_onslope = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// reset abort land, unless loitering after an abort</span></span><br><span class="line">	<span class="keyword">if</span> (_land_abort &amp;&amp; (_pos_sp_triplet.current.type != position_setpoint_s::SETPOINT_TYPE_LOITER)) &#123;</span><br><span class="line"></span><br><span class="line">		abort_landing(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">FixedwingPositionControl::tecs_update_pitch_throttle(<span class="keyword">float</span> alt_sp, <span class="keyword">float</span> airspeed_sp,</span><br><span class="line">		<span class="keyword">float</span> pitch_min_rad, <span class="keyword">float</span> pitch_max_rad,</span><br><span class="line">		<span class="keyword">float</span> throttle_min, <span class="keyword">float</span> throttle_max, <span class="keyword">float</span> throttle_cruise,</span><br><span class="line">		<span class="keyword">bool</span> climbout_mode, <span class="keyword">float</span> climbout_pitch_min_rad,</span><br><span class="line">		<span class="keyword">uint8_t</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> dt = <span class="number">0.01f</span>; <span class="comment">// prevent division with 0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_last_tecs_update &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		dt = hrt_elapsed_time(&amp;_last_tecs_update) * <span class="number">1e-6</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_last_tecs_update = hrt_absolute_time();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// do not run TECS if we are not in air</span></span><br><span class="line">	<span class="keyword">bool</span> run_tecs = !_vehicle_land_detected.landed;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// do not run TECS if vehicle is a VTOL and we are in rotary wing mode or in transition</span></span><br><span class="line">	<span class="comment">// (it should also not run during VTOL blending because airspeed is too low still)</span></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_status.is_vtol) &#123;</span><br><span class="line">		<span class="keyword">if</span> (_vehicle_status.is_rotary_wing || _vehicle_status.in_transition_mode) &#123;</span><br><span class="line">			run_tecs = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (_vehicle_status.in_transition_mode) &#123;</span><br><span class="line">			<span class="comment">// we're in transition</span></span><br><span class="line">			_was_in_transition = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// set this to transition airspeed to init tecs correctly</span></span><br><span class="line">			<span class="keyword">if</span> (_parameters.airspeed_disabled) &#123;</span><br><span class="line">				<span class="comment">// some vtols fly without airspeed sensor</span></span><br><span class="line">				_asp_after_transition = _parameters.airspeed_trans;</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				_asp_after_transition = _airspeed;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			_asp_after_transition = <span class="built_in">constrain</span>(_asp_after_transition, _parameters.airspeed_min, _parameters.airspeed_max);</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (_was_in_transition) &#123;</span><br><span class="line">			<span class="comment">// after transition we ramp up desired airspeed from the speed we had coming out of the transition</span></span><br><span class="line">			_asp_after_transition += dt * <span class="number">2</span>; <span class="comment">// increase 2m/s</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (_asp_after_transition &lt; airspeed_sp &amp;&amp; _airspeed &lt; airspeed_sp) &#123;</span><br><span class="line">				airspeed_sp = <span class="built_in">max</span>(_asp_after_transition, _airspeed);</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				_was_in_transition = <span class="literal">false</span>;</span><br><span class="line">				_asp_after_transition = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_is_tecs_running = run_tecs;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!run_tecs) &#123;</span><br><span class="line">		<span class="comment">// next time we run TECS we should reinitialize states</span></span><br><span class="line">		_reinitialize_tecs = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_reinitialize_tecs) &#123;</span><br><span class="line">		_tecs.reset_state();</span><br><span class="line">		_reinitialize_tecs = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_vehicle_status.engine_failure) &#123;</span><br><span class="line">		<span class="comment">/* Force the slow downwards spiral */</span></span><br><span class="line">		pitch_min_rad = M_DEG_TO_RAD_F * <span class="number">-1.0f</span>;</span><br><span class="line">		pitch_max_rad = M_DEG_TO_RAD_F * <span class="number">5.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* No underspeed protection in landing mode */</span></span><br><span class="line">	_tecs.set_detect_underspeed_enabled(!(mode == tecs_status_s::TECS_MODE_LAND</span><br><span class="line">					      || mode == tecs_status_s::TECS_MODE_LAND_THROTTLELIM));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Using tecs library */</span></span><br><span class="line">	<span class="keyword">float</span> pitch_for_tecs = _pitch - _parameters.pitchsp_offset_rad;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* filter speed and altitude for controller */</span></span><br><span class="line">	<span class="function">Vector3f <span class="title">accel_body</span><span class="params">(_sub_sensors.<span class="built_in">get</span>().accel_x, _sub_sensors.<span class="built_in">get</span>().accel_y, _sub_sensors.<span class="built_in">get</span>().accel_z)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// tailsitters use the multicopter frame as reference, in fixed wing</span></span><br><span class="line">	<span class="comment">// we need to use the fixed wing frame</span></span><br><span class="line">	<span class="keyword">if</span> (_parameters.vtol_type == vtol_type::TAILSITTER &amp;&amp; _vehicle_status.is_vtol) &#123;</span><br><span class="line">		<span class="keyword">float</span> tmp = accel_body(<span class="number">0</span>);</span><br><span class="line">		accel_body(<span class="number">0</span>) = -accel_body(<span class="number">2</span>);</span><br><span class="line">		accel_body(<span class="number">2</span>) = tmp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* tell TECS to update its state, but let it know when it cannot actually control the plane */</span></span><br><span class="line">	<span class="keyword">bool</span> in_air_alt_control = (!_vehicle_land_detected.landed &amp;&amp;</span><br><span class="line">				   (_control_mode.flag_control_auto_enabled ||</span><br><span class="line">				    _control_mode.flag_control_velocity_enabled ||</span><br><span class="line">				    _control_mode.flag_control_altitude_enabled));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* update TECS vehicle state estimates */</span></span><br><span class="line">	_tecs.update_vehicle_state_estimates(_airspeed, _R_nb,</span><br><span class="line">					     accel_body, (_global_pos.timestamp &gt; <span class="number">0</span>), in_air_alt_control,</span><br><span class="line">					     _global_pos.alt, _local_pos.v_z_valid, _local_pos.vz, _local_pos.az);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* scale throttle cruise by baro pressure */</span></span><br><span class="line">	<span class="keyword">if</span> (_parameters.throttle_alt_scale &gt; FLT_EPSILON) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">bool</span> baro_updated = <span class="literal">false</span>;</span><br><span class="line">		orb_check(_sensor_baro_sub, &amp;baro_updated);</span><br><span class="line"></span><br><span class="line">		sensor_baro_s baro;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (orb_copy(ORB_ID(sensor_baro), _sensor_baro_sub, &amp;baro) == PX4_OK) &#123;</span><br><span class="line">			<span class="keyword">if</span> (PX4_ISFINITE(baro.pressure) &amp;&amp; PX4_ISFINITE(_parameters.throttle_alt_scale)) &#123;</span><br><span class="line">				<span class="comment">// scale throttle as a function of sqrt(p0/p) (~ EAS -&gt; TAS at low speeds and altitudes ignoring temperature)</span></span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">float</span> eas2tas = sqrtf(CONSTANTS_STD_PRESSURE_MBAR / baro.pressure);</span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">float</span> scale = <span class="built_in">constrain</span>((eas2tas - <span class="number">1.0f</span>) * _parameters.throttle_alt_scale + <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">2.0f</span>);</span><br><span class="line"></span><br><span class="line">				throttle_max = <span class="built_in">constrain</span>(throttle_max * scale, throttle_min, <span class="number">1.0f</span>);</span><br><span class="line">				throttle_cruise = <span class="built_in">constrain</span>(throttle_cruise * scale, throttle_min + <span class="number">0.01f</span>, throttle_max - <span class="number">0.01f</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_tecs.update_pitch_throttle(_R_nb, pitch_for_tecs,</span><br><span class="line">				    _global_pos.alt, alt_sp,</span><br><span class="line">				    airspeed_sp, _airspeed, _eas2tas,</span><br><span class="line">				    climbout_mode, climbout_pitch_min_rad,</span><br><span class="line">				    throttle_min, throttle_max, throttle_cruise,</span><br><span class="line">				    pitch_min_rad, pitch_max_rad);</span><br><span class="line"></span><br><span class="line">	tecs_status_publish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FixedwingPositionControl *<span class="title">FixedwingPositionControl::instantiate</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> FixedwingPositionControl();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FixedwingPositionControl::task_spawn</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_task_id = px4_task_spawn_cmd(<span class="string">"fw_pos_control_l1"</span>,</span><br><span class="line">				      SCHED_DEFAULT,</span><br><span class="line">				      SCHED_PRIORITY_POSITION_CONTROL,</span><br><span class="line">				      <span class="number">1810</span>,</span><br><span class="line">				      (<span class="keyword">px4_main_t</span>)&amp;run_trampoline,</span><br><span class="line">				      (<span class="keyword">char</span> *<span class="keyword">const</span> *)argv);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_task_id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		_task_id = <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">return</span> -errno;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FixedwingPositionControl::custom_command</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> print_usage(<span class="string">"unknown command"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FixedwingPositionControl::print_usage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *reason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (reason) &#123;</span><br><span class="line">		PX4_WARN(<span class="string">"%s\n"</span>, reason);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PRINT_MODULE_DESCRIPTION(</span><br><span class="line">		R<span class="string">"DESCR_STR(</span></span><br><span class="line"><span class="string">### Description</span></span><br><span class="line"><span class="string">fw_pos_control_l1 is the fixed wing position controller.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">)DESCR_STR"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	PRINT_MODULE_USAGE_NAME(<span class="string">"fw_pos_control_l1"</span>, <span class="string">"controller"</span>);</span><br><span class="line">	PRINT_MODULE_USAGE_COMMAND(<span class="string">"start"</span>);</span><br><span class="line">	PRINT_MODULE_USAGE_DEFAULT_COMMANDS();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FixedwingPositionControl::print_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PX4_INFO(<span class="string">"Running"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fw_pos_control_l1_main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FixedwingPositionControl::main(argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PX4/" rel="tag"># PX4</a>
              <a href="/tags/Cybernetic/" rel="tag"># Cybernetic</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/10/22/dl-01/" rel="prev" title="牛顿法和梯度下降法">
      <i class="fa fa-chevron-left"></i> 牛顿法和梯度下降法
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/10/29/dl-02/" rel="next" title="Numpy库拾遗">
      Numpy库拾遗 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-摘要"><span class="nav-text">0. 摘要</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-头文件分析"><span class="nav-text">1. 头文件分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-命名规则"><span class="nav-text">1.1 命名规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-库的引用"><span class="nav-text">1.2 库的引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-数学工具"><span class="nav-text">1.3 数学工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-FixedwingPositionControl类"><span class="nav-text">1.4 FixedwingPositionControl类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-1-public"><span class="nav-text">1.4.1 public</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-2-飞行参数"><span class="nav-text">1.4.2 飞行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-3-飞行状态量"><span class="nav-text">1.4.3 飞行状态量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-4-底层函数"><span class="nav-text">1.4.4 底层函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-4-1-飞行参数更新函数param-update"><span class="nav-text">1.4.4.1 飞行参数更新函数param_update</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-4-2-飞行状态量的订阅更新和发布函数"><span class="nav-text">1.4.4.2 飞行状态量的订阅更新和发布函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-4-3-等级仅次于run的控制函数"><span class="nav-text">1.4.4.3 等级仅次于run的控制函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-4-4-其他飞控相关的底层函数"><span class="nav-text">1.4.4.4 其他飞控相关的底层函数</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-源文件分析"><span class="nav-text">2. 源文件分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-附录"><span class="nav-text">3. 附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-头文件"><span class="nav-text">3.1 头文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-源文件"><span class="nav-text">3.2 源文件</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhenhui Ye"
      src="/images/face.jpg">
  <p class="site-author-name" itemprop="name">Zhenhui Ye</p>
  <div class="site-description" itemprop="description">Be a superhero.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yerfor" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yerfor" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhenhuiye@zju.edu.com" title="E-Mail → mailto:zhenhuiye@zju.edu.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhenhui Ye</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

</body>
</html>
